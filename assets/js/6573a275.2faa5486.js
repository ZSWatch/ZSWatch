(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[6019],{1909:function(e,t,r){var s,a;!function(i,n){"use strict";var l=4294967296,o=9007199254740992;(a="function"==typeof(s={encode:function(e){var t,r=new ArrayBuffer(256),s=new DataView(r),a=0;function i(e){for(var i=r.byteLength,n=a+e;i<n;)i<<=1;if(i!==r.byteLength){var l=s;r=new ArrayBuffer(i),s=new DataView(r);for(var o=a+3>>2,d=0;d<o;++d)s.setUint32(d<<2,l.getUint32(d<<2))}return t=e,s}function d(){a+=t}function c(e){d(i(1).setUint8(a,e))}function h(e){for(var t=i(e.length),r=0;r<e.length;++r)t.setUint8(a+r,e[r]);d()}function u(e,t){t<24?c(e<<5|t):t<256?(c(e<<5|24),c(t)):t<65536?(c(e<<5|25),function(e){d(i(2).setUint16(a,e))}(t)):t<4294967296?(c(e<<5|26),function(e){d(i(4).setUint32(a,e))}(t)):(c(e<<5|27),function(e){var t=e%l,r=(e-t)/l,s=i(8);s.setUint32(a,r),s.setUint32(a+4,t),d()}(t))}if(function e(t){var r;if(!1===t)return c(244);if(!0===t)return c(245);if(null===t)return c(246);if(t===n)return c(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(0<=t&&t<=o)return u(0,t);if(-o<=t&&t<0)return u(1,-(t+1))}return c(251),function(e){d(i(8).setFloat64(a,e))}(t);case"string":var s=[];for(r=0;r<t.length;++r){var l=t.charCodeAt(r);l<128?s.push(l):l<2048?(s.push(192|l>>6),s.push(128|63&l)):l<55296?(s.push(224|l>>12),s.push(128|l>>6&63),s.push(128|63&l)):(l=(1023&l)<<10,l|=1023&t.charCodeAt(++r),l+=65536,s.push(240|l>>18),s.push(128|l>>12&63),s.push(128|l>>6&63),s.push(128|63&l))}return u(3,s.length),h(s);default:var g;if(Array.isArray(t))for(u(4,g=t.length),r=0;r<g;++r)e(t[r]);else if(t instanceof Uint8Array)u(2,t.length),h(t);else{var m=Object.keys(t);for(u(5,g=m.length),r=0;r<g;++r){var f=m[r];e(f),e(t[f])}}}}(e),"slice"in r)return r.slice(0,a);for(var g=new ArrayBuffer(a),m=new DataView(g),f=0;f<a;++f)m.setUint8(f,s.getUint8(f));return g},decode:function(e,t,r){var s=new DataView(e),a=0;function i(e,t){return a+=e,t}function o(t){return i(t,new Uint8Array(e,a,t))}function d(){return i(1,s.getUint8(a))}function c(){return i(2,s.getUint16(a))}function h(){return i(4,s.getUint32(a))}function u(){return 255===s.getUint8(a)&&(a+=1,!0)}function g(e){if(e<24)return e;if(24===e)return d();if(25===e)return c();if(26===e)return h();if(27===e)return h()*l+h();if(31===e)return-1;throw"Invalid length encoding"}function m(e){var t=d();if(255===t)return-1;var r=g(31&t);if(r<0||t>>5!==e)throw"Invalid indefinite length element";return r}function f(e,t){for(var r=0;r<t;++r){var s=d();128&s&&(s<224?(s=(31&s)<<6|63&d(),t-=1):s<240?(s=(15&s)<<12|(63&d())<<6|63&d(),t-=2):(s=(15&s)<<18|(63&d())<<12|(63&d())<<6|63&d(),t-=3)),s<65536?e.push(s):(s-=65536,e.push(55296|s>>10),e.push(56320|1023&s))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof r&&(r=function(){return n});var p=function e(){var l,h,p=d(),x=p>>5,b=31&p;if(7===x)switch(b){case 25:return function(){var e=new ArrayBuffer(4),t=new DataView(e),r=c(),s=32768&r,a=31744&r,i=1023&r;if(31744===a)a=261120;else if(0!==a)a+=114688;else if(0!==i)return(s?-1:1)*i*5.960464477539063e-8;return t.setUint32(0,s<<16|a<<13|i<<13),t.getFloat32(0)}();case 26:return i(4,s.getFloat32(a));case 27:return i(8,s.getFloat64(a))}if((h=g(b))<0&&(x<2||6<x))throw"Invalid length";switch(x){case 0:return h;case 1:return-1-h;case 2:if(h<0){for(var y=[],w=0;(h=m(x))>=0;)w+=h,y.push(o(h));var _=new Uint8Array(w),v=0;for(l=0;l<y.length;++l)_.set(y[l],v),v+=y[l].length;return _}return o(h);case 3:var k=[];if(h<0)for(;(h=m(x))>=0;)f(k,h);else f(k,h);return String.fromCharCode.apply(null,k);case 4:var j;if(h<0)for(j=[];!u();)j.push(e());else for(j=new Array(h),l=0;l<h;++l)j[l]=e();return j;case 5:var N={};for(l=0;l<h||h<0&&!u();++l){N[e()]=e()}return N;case 6:return t(e(),h);case 7:switch(h){case 20:return!1;case 21:return!0;case 22:return null;case 23:return n;default:return r(h)}}}();if(a!==e.byteLength)throw"Remaining bytes";return p}})?s.call(t,r,t,e):s)===n||(e.exports=a)}()},7551:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>A});var s=r(6540),a=r(6908),i=r(4848);const n=e=>{let{firmwares:t,isFetchingFirmwares:r,onFetchFirmwares:a,onDownloadFirmware:n,isConnected:l=!1}=e;const[o,d]=(0,s.useState)({}),c=t.filter((e=>e.artifacts&&e.artifacts.length>0)),h=e=>{const t=(e||"").toLowerCase();return t.includes("_release")||t.endsWith("release")?"release":t.includes("_debug")||t.endsWith("debug")?"debug":""},u=c.reduce(((e,t)=>(e[t.branch]||(e[t.branch]=[]),e[t.branch].push(t),e)),{});return(0,i.jsx)("div",{className:"space-y-3",children:r?(0,i.jsxs)("div",{className:"text-center py-6",children:[(0,i.jsx)("div",{className:"inline-flex items-center justify-center w-6 h-6 bg-zswatch-secondary rounded-full animate-spin mb-2",children:(0,i.jsx)("span",{className:"text-white text-xs",children:"\u23f3"})}),(0,i.jsx)("p",{className:"text-gray-700 dark:text-white text-sm",children:"Loading firmwares..."})]}):0===c.length?(0,i.jsxs)("div",{className:"text-center py-6 bg-gray-50 dark:bg-black/20 border border-gray-200 dark:border-white/10 rounded-lg",children:[(0,i.jsx)("span",{className:"text-2xl mb-2 block",children:"\ud83d\udce6"}),(0,i.jsx)("p",{className:"text-gray-700 dark:text-white text-sm",children:"No firmwares fetched yet"}),(0,i.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:'Click "Fetch Latest" to get builds'})]}):(0,i.jsx)("div",{className:"space-y-2",children:Object.entries(u).map((e=>{let[t,r]=e;return(0,i.jsxs)("div",{className:"border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden",children:[(0,i.jsx)("div",{className:"bg-gray-50 dark:bg-black/20 px-3 py-2 border-b border-gray-200 dark:border-white/10",children:(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t}),"main"===t&&(0,i.jsx)("span",{className:"text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-2 py-1 rounded-full",children:"Release"}),"main"!==t&&(0,i.jsx)("span",{className:"text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-1 rounded-full",children:"Debug"})]}),(0,i.jsxs)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:[r.length," build",1!==r.length?"s":""]})]})}),(0,i.jsx)("div",{className:"space-y-1",children:r.map(((e,r)=>{const s=`${t}-${r}`,a=e.sha?e.sha.substring(0,7):"",l=e.commitMessage?e.commitMessage.split("\n")[0]:"",c=e.createdAt?new Date(e.createdAt).toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"";return(0,i.jsxs)("div",{className:"border-b border-gray-100 dark:border-white/5 last:border-b-0",children:[(0,i.jsxs)("button",{onClick:()=>(e=>{d((t=>({...t,[e]:!t[e]})))})(s),className:"w-full flex items-center justify-between p-2 bg-gray-100 dark:bg-white/10 hover:bg-gray-200 dark:hover:bg-white/15 transition-all",children:[(0,i.jsxs)("div",{className:"flex flex-col items-start gap-0.5 overflow-hidden text-left",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsxs)("span",{className:"text-xs text-gray-600 dark:text-gray-300",children:["by ",e.user]}),(0,i.jsxs)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:[e.artifacts.length," artifact",1!==e.artifacts.length?"s":""]}),c&&(0,i.jsxs)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:["\u2022 ",c]})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2 w-full",children:[(0,i.jsx)("span",{className:"text-[11px] text-gray-500 dark:text-gray-400 font-mono",children:a||"unknown"}),(0,i.jsx)("span",{className:"text-xs text-gray-600 dark:text-gray-300 truncate",title:e.commitMessage||"",children:l||"No commit message"})]})]}),(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsx)("span",{className:"text-xs transition-transform "+(o[s]?"rotate-180":""),children:"\u25bc"})})]}),o[s]&&(0,i.jsx)("div",{className:"px-3 pb-2",children:(0,i.jsx)("div",{className:"space-y-1",children:e.artifacts.map(((t,r)=>{return(0,i.jsxs)("div",{className:"flex items-center gap-2 min-w-0 p-2 bg-gray-50 dark:bg-white/5 hover:bg-gray-100 dark:hover:bg-white/10 rounded border border-gray-200 dark:border-white/10 transition-colors",children:[(0,i.jsxs)("div",{className:"flex-1 min-w-0 flex items-center gap-2",children:[(0,i.jsx)("span",{className:"min-w-0 text-xs text-gray-700 dark:text-gray-300 font-mono truncate",title:t.name,children:(s=t.name,s?s.replace(/_(debug|release)$/i,""):"")}),h(t.name)&&(0,i.jsx)("span",{className:"shrink-0 text-[10px] px-2 py-0.5 rounded-full border font-medium "+("release"===h(t.name)?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border-green-200 dark:border-green-800":"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-800"),children:"release"===h(t.name)?"Release":"Debug"})]}),(0,i.jsx)("button",{onClick:()=>n(e.runId,t.id),className:"shrink-0 bg-zswatch-primary text-black px-2 py-1 rounded text-xs font-medium hover:bg-zswatch-primary/90 transition-all",children:"Download"})]},r);var s}))})})]},r)}))})]},t)}))})})},l=e=>{let{fileInputRef:t,fileStatus:r,fileUploadPercentage:a,fileUploadSpeed:n,fileInfos:l,isFileUploadInProgress:o,onFileChange:d,onFileUpload:c,onEraseFiles:h,onConfirmFiles:u,isConnected:g=!1,isSerialRecoveryMode:m=!0}=e;const[f,p]=s.useState(!1);return(0,i.jsxs)("div",{className:"space-y-6",children:[(0,i.jsxs)("div",{className:"relative",children:[(0,i.jsx)("input",{type:"file",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",onChange:d,ref:t,accept:".zip,.bin"}),(0,i.jsx)("div",{className:`\n            relative border-2 border-dashed rounded-xl p-4 text-center transition-all duration-200\n            ${f?"border-zswatch-primary bg-zswatch-primary/5 scale-105":"border-gray-300 dark:border-gray-600 hover:border-zswatch-primary/50 hover:bg-zswatch-primary/5"}\n          `,onDragOver:e=>{e.preventDefault(),p(!0)},onDragLeave:e=>{e.preventDefault(),p(!1)},onDrop:e=>{if(e.preventDefault(),p(!1),e.dataTransfer.files.length>0){const t={target:{files:e.dataTransfer.files}};d(t)}},children:(0,i.jsxs)("div",{className:"transition-all duration-200 "+(f?"scale-110":""),children:[(0,i.jsx)("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:f?"Drop your files here":"Upload Firmware Files"}),(0,i.jsxs)("p",{className:"text-gray-600 dark:text-gray-400 mb-2",children:["Drag and drop the ",(0,i.jsx)("code",{children:"dfu_application.zip"})," from your firmware package here"]})]})})]}),null!==a&&(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,i.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:"Upload Progress"}),(0,i.jsxs)("span",{className:"font-medium text-gray-900 dark:text-white",children:[a,"%"]})]}),(0,i.jsx)("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:(0,i.jsx)("div",{className:"bg-gradient-to-r from-zswatch-secondary to-zswatch-primary h-3 rounded-full transition-all duration-300 relative overflow-hidden",style:{width:`${a}%`},children:(0,i.jsx)("div",{className:"absolute inset-0 bg-white/20 animate-pulse"})})}),n&&(0,i.jsxs)("p",{className:"text-sm text-gray-600 dark:text-gray-400 text-right",children:[n," KB/s"]})]}),l&&l.length>0&&(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsxs)("h4",{className:"text-sm font-medium text-gray-900 dark:text-white",children:["\ud83d\udccb Files (",l.length,")",r&&"Select image files (.bin or .zip)"!==r&&(0,i.jsxs)("span",{className:"ml-2 text-xs text-gray-600 dark:text-gray-400",children:["- ",r]})]})}),(0,i.jsx)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-3",children:l.map(((e,t)=>{return(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-lg p-3",children:(0,i.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,i.jsxs)("div",{className:"flex items-start gap-2 min-w-0 flex-1",children:[(0,i.jsx)("span",{className:"text-sm mt-0.5",children:"\ud83d\udcc4"}),(0,i.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,i.jsx)("h5",{className:"font-medium text-gray-900 dark:text-white text-sm truncate mb-1",children:e.name}),(0,i.jsxs)("div",{className:"space-y-1",children:[(0,i.jsxs)("div",{className:"flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400",children:[(0,i.jsxs)("span",{className:"bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded",children:["Image #",e.imageNumber]}),(0,i.jsxs)("span",{children:["v",e.version]})]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:(r=e.fileSize,(r/1024).toFixed(1)+" KB")})]})]})]}),(0,i.jsxs)("div",{className:"flex flex-col items-end gap-1 flex-shrink-0 ml-2",children:[e.isUploaded&&(0,i.jsx)("span",{className:"bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400 px-2 py-1 rounded text-xs",children:"\u2705 Done"}),e.isUploading&&(0,i.jsxs)("span",{className:"bg-blue-100 dark:bg-blue-500/20 text-blue-700 dark:text-blue-400 px-2 py-1 rounded text-xs flex items-center gap-1",children:[(0,i.jsx)("div",{className:"w-2 h-2 border border-blue-500 border-t-transparent rounded-full animate-spin"}),e.uploadPercentage||0,"%"]})]})]})},t);var r}))})]}),(0,i.jsxs)("div",{className:"flex flex-wrap gap-3 mt-4",children:[(0,i.jsx)("button",{onClick:c,disabled:!l||0===l.length||o||!g,className:"flex-1 px-4 py-2 text-sm font-medium transition-all border rounded group bg-blue-50 dark:bg-blue-500/10 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-500/30 hover:bg-blue-100 dark:hover:bg-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,i.jsx)("div",{className:"relative",children:o?"Uploading...":"Upload Firmware"})}),!m&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{onClick:h,disabled:!g,className:"flex-1 px-4 py-2 text-sm font-medium transition-all border rounded group bg-red-50 dark:bg-red-500/10 text-red-700 dark:text-red-400 border-red-200 dark:border-red-500/30 hover:bg-red-100 dark:hover:bg-red-500/20 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,i.jsx)("div",{className:"relative",children:"Erase Files"})}),(0,i.jsx)("button",{onClick:u,disabled:!g,className:"flex-1 px-4 py-2 text-sm font-medium transition-all border rounded group bg-gray-50 dark:bg-white/5 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-white/10 hover:bg-gray-100 dark:hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,i.jsx)("div",{className:"relative",children:"Confirm Files"})})]})]})]})},o=e=>{let{fileFsInputRef:t,fileSystemUploadStatus:r,fileSystemUploadProgress:a,fileSystemUploadSpeed:n,onFileSystemSelection:l,onFileSystemUploadStart:o,isConnected:d=!1,isSerialRecoveryMode:c=!0}=e;const[h,u]=(0,s.useState)(!1),g=!c&&d;return(0,i.jsxs)("div",{className:"space-y-6",children:[(0,i.jsxs)("div",{className:"relative",children:[(0,i.jsx)("input",{type:"file",ref:t,onChange:l,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",accept:".bin"}),(0,i.jsx)("div",{className:`\n            relative border-2 border-dashed rounded-xl p-4 text-center transition-all duration-200\n            ${h?"border-zswatch-secondary bg-zswatch-secondary/5 scale-105":"border-gray-300 dark:border-gray-600 hover:border-zswatch-secondary/50 hover:bg-zswatch-secondary/5"}\n          `,onDragOver:e=>{e.preventDefault(),u(!0)},onDragLeave:e=>{e.preventDefault(),u(!1)},onDrop:e=>{if(e.preventDefault(),u(!1),e.dataTransfer.files.length>0){const t={target:{files:e.dataTransfer.files}};l(t)}},children:(0,i.jsxs)("div",{className:"transition-all duration-200 "+(h?"scale-110":""),children:[(0,i.jsx)("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:h?"Drop your file system file here":"Upload File System"}),(0,i.jsxs)("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:["Drag and drop your ",(0,i.jsx)("code",{children:"lvgl_resources_raw.bin"})," file here to upload icons and graphics."]}),(0,i.jsxs)("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:["This file is included in the firmware download package from"," ",(0,i.jsx)("a",{href:"https://github.com/ZSWatch/ZSWatch/releases",target:"_blank",rel:"noopener noreferrer",className:"underline text-zswatch-primary",children:"GitHub Releases"})," ","or ",(0,i.jsx)("a",{href:"https://github.com/ZSWatch/ZSWatch/actions",target:"_blank",rel:"noopener noreferrer",className:"underline text-zswatch-primary",children:"GitHub Actions"}),"."]})]})})]}),!d&&(0,i.jsx)("div",{className:"text-xs text-gray-600 dark:text-gray-300",children:"\u2139\ufe0f Please connect to device to upload filesystem."}),d&&c&&(0,i.jsx)("div",{className:"text-xs text-amber-600 dark:text-amber-400",children:"\u26a0\ufe0f Filesystem upload not available. Device must be running the application (not in MCUBoot mode)."}),null!==a&&(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,i.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:"Upload Progress"}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsxs)("span",{className:"font-medium text-gray-900 dark:text-white",children:[a,"%"]}),n&&(0,i.jsxs)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:["(",n," KB/s)"]})]})]}),(0,i.jsx)("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:(0,i.jsx)("div",{className:"bg-gradient-to-r from-zswatch-secondary to-zswatch-primary h-3 rounded-full transition-all duration-300 relative overflow-hidden",style:{width:`${a}%`},children:(0,i.jsx)("div",{className:"absolute inset-0 bg-white/20 animate-pulse"})})})]}),r&&"Select a filesystem file"!==r&&(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsxs)("h4",{className:"text-sm font-medium text-gray-900 dark:text-white",children:["\ud83d\udccb File System",(0,i.jsxs)("span",{className:"ml-2 text-xs text-gray-600 dark:text-gray-400",children:["- ",r]})]})}),(0,i.jsx)("div",{className:"flex gap-3",children:(0,i.jsx)("button",{onClick:o,disabled:!g||null!==a,className:"flex-1 px-4 py-2 text-sm font-medium transition-all border rounded group bg-blue-50 dark:bg-blue-500/10 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-500/30 hover:bg-blue-100 dark:hover:bg-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,i.jsx)("div",{className:"relative",children:null!==a?"Uploading...":"Upload File System"})})})]})]})},d=e=>{if(!e)return[];return(Array.isArray(e)?e:[e]).filter((e=>"string"==typeof e)).flatMap((e=>e.replace(/\r/g,"").split("\n"))).map((e=>e.replace(/\s+$/g,"")))},c=e=>{let{mcumgr:t,registerShellListener:r,isConnected:a,className:n="",textareaClassName:l=""}=e;const[o,c]=(0,s.useState)(["Connect first","Type 'help' to list commands."]),[h,u]=(0,s.useState)(""),g=(0,s.useRef)(null),m=(0,s.useRef)([]),f=(0,s.useRef)(new Map),p=(0,s.useRef)(new Map),x=(0,s.useRef)(0),b=(0,s.useRef)(!1),y=(0,s.useCallback)((e=>{const t=d(e);0!==t.length&&c((e=>[...e,...t]))}),[]),w=(0,s.useMemo)((()=>`${o.length?`${o.join("\n")}\n`:""}$ ${h}`),[o,h]),_=(0,s.useCallback)((e=>{m.current=m.current.filter((t=>t!==e)),f.current.delete(e)}),[]),v=(0,s.useCallback)(((e,t)=>{const r=p.current.get(e);r&&clearTimeout(r),p.current.delete(e);const s=f.current.get(e);_(e);const a=t?.message||"Failed to send command";y(s?.suppressOutput?a:`  !! ${a}`)}),[y,_]),k=(0,s.useCallback)((function(e,r){let{suppressOutput:s=!1}=void 0===r?{}:r;if(!t||"function"!=typeof t.cmdShellExec)return;const a=e.trim();if(0===a.length)return;const i=x.current+=1;s||y(`$ ${a}`),m.current.push(i),f.current.set(i,{suppressOutput:s,command:a});const n=setTimeout((()=>{p.current.delete(i);const e=f.current.get(i);_(i),y(e?.suppressOutput?"Shell request timed out":"  !! timeout")}),5e3);p.current.set(i,n);try{const r=t.cmdShellExec([e]);r&&"function"==typeof r.then&&r.catch((e=>v(i,e)))}catch(l){v(i,l)}}),[y,_,v,t]),j=(0,s.useCallback)((e=>{const{data:t={}}=e||{};if(0===m.current.length)return;const r=m.current.shift(),s=p.current.get(r);s&&clearTimeout(s),p.current.delete(r);f.current.get(r);_(r);const a="string"==typeof t.o?t.o:"",i="number"==typeof t.ret?t.ret:null,n=d(a);if(n.length>0&&y(n),"number"==typeof i){y(`${0===i?"  ret":"  !! ret"} ${i}`)}if(t&&"object"==typeof t&&t.err){const{group:e,rc:r}=t.err,s=["  mgmt rc",r];void 0!==e&&s.push("group",e),y(s.join(" "))}}),[y,_]);(0,s.useEffect)((()=>{if(!r)return;const e=r(j);return()=>{e&&e()}}),[r,j]),(0,s.useEffect)((()=>()=>{p.current.forEach((e=>clearTimeout(e))),p.current.clear(),m.current=[],f.current.clear()}),[]),(0,s.useEffect)((()=>{const e=g.current;e&&(e.selectionStart=w.length,e.selectionEnd=w.length,e.scrollTop=e.scrollHeight)}),[w]),(0,s.useEffect)((()=>{if(!a)return;const e=g.current;e&&e.focus()}),[a]);const N=(0,s.useCallback)((()=>{if(!a)return;const e=h;u(""),k(e,{logCommand:!0})}),[h,a,k]),S=(0,s.useCallback)((()=>{a&&(b.current||(y("Tab completion is not supported over the mcumgr shell interface."),b.current=!0))}),[y,a]),C=(0,s.useCallback)((e=>{if(!a)return;const t=e.target.value,r=o.length?`${o.join("\n")}\n`:"",s=r.length+2;!t.startsWith(r)||t.length<s?e.target.value=w:u(t.slice(s))}),[w,a,o]),U=(0,s.useCallback)((e=>{if(a)return"Enter"===e.key?(e.preventDefault(),void N()):"Tab"===e.key?(e.preventDefault(),void S()):void("Backspace"===e.key&&0===h.length&&e.preventDefault());e.preventDefault()}),[h.length,N,S,a]),F=["bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-3 shadow-sm",n].filter(Boolean).join(" "),I=["w-full h-64 bg-black text-green-200 font-mono text-xs rounded-md p-3 resize-none focus:outline-none focus:ring-2 focus:ring-zswatch-primary/40",l].filter(Boolean).join(" ");return(0,i.jsx)("div",{className:F,children:(0,i.jsx)("textarea",{ref:g,value:w,onChange:C,onKeyDown:U,spellCheck:!1,readOnly:!a,className:I})})};var h=r(1909),u=r.n(h);const g="idle",m="recv_pkt_second",f="recv_frag_second",p="collect_pkt",x="collect_frag",b=1545,y=1044;const w=class{constructor(e){void 0===e&&(e={}),this.SERVICE_UUID="8d53dc1d-1db7-4cd3-868b-8a527460aa84",this.CHARACTERISTIC_UUID="da2e7828-fbce-4e01-ae9e-261174997c48",this._mtu=244,this._netbuf_size=2450,this._device=null,this._service=null,this._characteristic=null,this._connectCallback=null,this._connectingCallback=null,this._disconnectCallback=null,this._messageCallback=null,this._imageUploadProgressCallback=null,this._uploadIsInProgress=!1,this._chunkTimeout=500,this._firstChunkTimeout=2e3,this._retryCount=0,this._buffer=new Uint8Array,this._logger=e.logger||{info:console.log,error:console.error},this._seq=0,this._userRequestedDisconnect=!1,this._transport=e.transport||"ble",this._bleDisconnectListener=null,this._serialPort=null,this._serialReader=null,this._serialWriter=null,this._serialReadLoopActive=!1,this._serialReadLoopPromise=null,this._serialReadChunkSize=e.serialReadChunkSize||512,this._serialWriteChunkSize=e.serialWriteChunkSize||512,this._serialDisconnectListener=null,this._serialFrameState=g,this._serialCurrentFrame=[],this._serialRxContext={buffer:new Uint8Array,expectedLength:null},this._deviceName=null}setTransport(e){if(!["ble","serial"].includes(e))throw new Error(`Unsupported transport: ${e}`);return this._transport=e,this}setChunkTimeout(e){if("number"!=typeof e||e<=0)throw new Error("Chunk timeout must be a positive number");return this._chunkTimeout=e,this._logger.info(`Chunk timeout set to ${e}ms`),this}_normalizeConnectOptions(e){let t=this._transport||"ble",r=null;return Array.isArray(e)||null===e?r=e:e&&"object"==typeof e&&(t=e.transport||t,r=e.filters??null),{transport:t,filters:r}}async _requestDevice(e){console.log(e);const t={acceptAllDevices:!0,optionalServices:[6159,this.SERVICE_UUID]};return e&&(t.filters=e,t.acceptAllDevices=!1),navigator.bluetooth.requestDevice(t)}async connect(e){void 0===e&&(e=null);const{transport:t,filters:r}=this._normalizeConnectOptions(e);if(this.setTransport(t),"ble"===t)return this._connectBle(r);if("serial"===t)return this._connectSerial();throw new Error(`Unsupported transport: ${t}`)}async _connectBle(e){try{this._bleDisconnectListener&&this._device&&this._device.removeEventListener("gattserverdisconnected",this._bleDisconnectListener),this._device=await this._requestDevice(e),this._deviceName=this._device&&this._device.name?this._device.name:"BLE Device",this._logger.info(`Connecting to device ${this.name||"unknown"} over BLE...`),this._bleDisconnectListener=async e=>{this._logger.info(e),this._userRequestedDisconnect?this._disconnected():(this._logger.info("Trying to reconnect"),this._connectBleWithDelay(1e3))},this._device.addEventListener("gattserverdisconnected",this._bleDisconnectListener),this._connectBleWithDelay(0)}catch(t){this._logger.error(t),await this._disconnected()}}_connectBleWithDelay(e){void 0===e&&(e=1e3),setTimeout((async()=>{try{this._connectingCallback&&this._connectingCallback();const e=await this._device.gatt.connect();this._logger.info("Server connected."),this._service=await e.getPrimaryService(this.SERVICE_UUID),this._logger.info("Service connected."),this._characteristic=await this._service.getCharacteristic(this.CHARACTERISTIC_UUID),this._logger.info("Characteristic connected."),this._characteristic.addEventListener("characteristicvaluechanged",this._notification.bind(this)),this._logger.info("Notifications enabled."),await this._characteristic.startNotifications(),this._logger.info("Notifications started."),this._mtu=e.mtu||this._mtu,this._logger.info(`MTU size: ${this._mtu} bytes`),this._device&&this._device.name&&(this._deviceName=this._device.name),await this._connected(),this._logger.info("Connected."),this._uploadIsInProgress&&this._uploadNext()}catch(e){this._logger.error(e),await this._disconnected()}}),e)}async _connectSerial(){try{if(!navigator.serial)throw new Error("Web Serial is not supported in this browser.");if(this._logger.info("Requesting serial port..."),this._serialPort=await navigator.serial.requestPort(),this._device=this._serialPort,this._connectingCallback&&this._connectingCallback(),await this._serialPort.open({baudRate:1e6,flowControl:"hardware"}),this._serialWriter){try{await this._serialWriter.close()}catch(e){this._logger.error("Serial writer close error:",e)}this._serialWriter=null}return this._serialWriter=this._serialPort.writable?this._serialPort.writable.getWriter():null,this._serialReadLoopActive=!0,this._serialFrameState=g,this._serialCurrentFrame=[],this._serialRxContext={buffer:new Uint8Array,expectedLength:null},this._buffer=new Uint8Array,this._mtu=256,this._serialDisconnectListener||(this._serialDisconnectListener=e=>{this._logger.info("Serial port disconnect event received"),e.target===this._serialPort&&(this._logger.info("Serial port disconnected."),this._disconnectSerial(!0))},navigator.serial.addEventListener("disconnect",this._serialDisconnectListener)),this._logger.info("Serial port opened."),await this._connected(),this._startSerialReadLoop(),this._uploadIsInProgress&&this._uploadNext(),this._serialPort}catch(t){this._logger.error(t),await this._disconnected()}}_startSerialReadLoop(){if(!this._serialPort||!this._serialPort.readable||!this._serialReadLoopActive)return;this._serialReader=this._serialPort.readable.getReader();this._serialReadLoopPromise=(async()=>{try{for(;this._serialReadLoopActive;){const{value:e,done:t}=await this._serialReader.read();if(t){this._logger.info("Serial stream closed");break}e&&this._handleIncoming(e)}}catch(e){this._logger.error("Serial read error:",e)}finally{if(this._serialReader){try{this._serialReader.releaseLock()}catch(t){this._logger.error("Failed to release serial reader lock:",t)}this._serialReader=null}}})()}async _disconnectSerial(e){if(void 0===e&&(e=!1),this._serialPort){if(this._logger.info("Disconnecting serial port..."),this._serialReadLoopActive=!1,this._serialReader)try{await this._serialReader.cancel()}catch(t){this._logger.error("Error cancelling serial reader:",t)}if(this._serialReadLoopPromise){try{await Promise.race([this._serialReadLoopPromise,new Promise((e=>setTimeout(e,1e3)))])}catch(t){this._logger.error("Serial read loop error:",t)}this._serialReadLoopPromise=null}if(this._serialWriter){try{await this._serialWriter.close()}catch(t){this._logger.error("Error closing serial writer:",t)}this._serialWriter=null}if(this._serialDisconnectListener){try{navigator.serial.removeEventListener("disconnect",this._serialDisconnectListener)}catch(t){this._logger.error("Failed to remove serial disconnect listener:",t)}this._serialDisconnectListener=null}if("function"==typeof this._serialPort?.setSignals)try{await this._serialPort.setSignals({dataTerminalReady:!1})}catch(t){}try{await this._serialPort.close()}catch(t){this._logger.error("Error closing serial port:",t)}this._serialPort=null,this._serialReader=null,this._serialFrameState=g,this._serialCurrentFrame=[],this._serialRxContext={buffer:new Uint8Array,expectedLength:null},await this._disconnected()}else await this._disconnected()}async disconnect(){return this._userRequestedDisconnect=!0,"serial"===this._transport?this._disconnectSerial():this._device&&this._device.gatt&&this._device.gatt.connected?this._device.gatt.disconnect():void await this._disconnected()}onConnecting(e){return this._connectingCallback=e,this}onConnect(e){return this._connectCallback=e,this}onDisconnect(e){return this._disconnectCallback=e,this}onMessage(e){return this._messageCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onFsUploadProgress(e){return this._fsUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}onFsUploadFinished(e){return this._fsUploadFinishedCallback=e,this}async _connected(){this._connectCallback&&this._connectCallback()}async _disconnected(){this._logger.info("Disconnected."),this._disconnectCallback&&this._disconnectCallback(),this._device=null,this._service=null,this._characteristic=null,this._uploadIsInProgress=!1,this._userRequestedDisconnect=!1,this._serialPort=null,this._serialReader=null,this._serialWriter=null,this._serialReadLoopActive=!1,this._serialReadLoopPromise=null,this._serialDisconnectListener=null,this._serialFrameState=g,this._serialCurrentFrame=[],this._serialRxContext={buffer:new Uint8Array,expectedLength:null},this._deviceName=null}get name(){return this._deviceName}isConnected(){return"serial"===this._transport?Boolean(this._serialPort&&this._serialWriter&&this._serialReadLoopActive):Boolean(this._device&&this._device.gatt&&this._device.gatt.connected)}sleep(e){return new Promise((t=>setTimeout(t,e)))}splitBuffer(e,t){void 0===t&&(t=20);const r=[],s=new Uint8Array(e);for(let a=0;a<s.length;a+=t)r.push(s.slice(a,a+t));return r}async writeLargeBuffer(e,t,r,s){void 0===r&&(r=20),void 0===s&&(s=1);const a=this.splitBuffer(e,r);for(const n of a){try{t.writeValueWithoutResponse(n)}catch(i){console.warn("Write failed:",i),await this.sleep(2*s);continue}await this.sleep(s)}}async _writeRaw(e){"serial"===this._transport?await this._writeSerial(e):this.writeLargeBuffer(e,this._characteristic,this._mtu,5)}async _writeSerial(e){if(!this._serialPort||!this._serialWriter)throw new Error("Serial port is not ready to send data.");const t=e instanceof Uint8Array?e:new Uint8Array(e),r=this._crc16(t),s=t.length+2,a=new Uint8Array(2+t.length+2);a[0]=s>>8&255,a[1]=255&s,a.set(t,2),a[a.length-2]=r>>8&255,a[a.length-1]=255&r;const i=3*Math.floor(31);let n=b,l=0;try{for(;l<a.length;){const e=a.length-l,t=Math.min(i,e),r=a.slice(l,l+t),s=this._buildSerialFrame(n,r);await this._serialWriter.write(s),l+=t,n=y}}catch(o){throw this._logger.error("Serial write error:",o),o}}_buildSerialFrame(e,t){const r=new Uint8Array([e>>8,255&e]),s=this._base64Encode(t),a=this._asciiToUint8(s),i=new Uint8Array(r.length+a.length+1);return i.set(r,0),i.set(a,r.length),i[i.length-1]=10,i}_base64Encode(e){if(!e||0===e.length)return"";let t="";for(let r=0;r<e.length;r+=1)t+=String.fromCharCode(e[r]);return btoa(t)}_base64Decode(e){if(!e)return new Uint8Array;try{const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e+=1)r[e]=t.charCodeAt(e);return r}catch(t){return this._logger.error("Failed to decode base64 serial frame:",t),null}}_asciiToUint8(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;r+=1)t[r]=e.charCodeAt(r);return t}_uint8ToAscii(e){let t="";for(let r=0;r<e.length;r+=1)t+=String.fromCharCode(e[r]);return t}async _sendMessage(e,t,r,s){let a=[];void 0!==s&&(a=[...new Uint8Array(u().encode(s))]);const i=255&a.length,n=[e,0,a.length>>8,i,t>>8,255&t,this._seq,r,...a];await this._writeRaw(Uint8Array.from(n)),this._seq=(this._seq+1)%256}_notification(e){e&&e.target&&this._handleIncoming(e.target.value)}_handleIncoming(e){if(!e)return;const t=this._normalizeIncomingData(e);t&&("serial"===this._transport?this._handleSerialBytes(t):this._appendToMessageBuffer(t))}_normalizeIncomingData(e){return e?e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)):e instanceof ArrayBuffer||Array.isArray(e)?new Uint8Array(e):null:null}_handleSerialBytes(e){for(const t of e)switch(this._serialFrameState){case g:6===t?(this._serialFrameState=m,this._serialCurrentFrame=[t]):4===t&&(this._serialFrameState=f,this._serialCurrentFrame=[t]);break;case m:9===t?(this._serialCurrentFrame.push(t),this._serialFrameState=p):(this._resetSerialFrameState(),6!==t&&4!==t||(this._serialFrameState=6===t?m:f,this._serialCurrentFrame=[t]));break;case f:20===t?(this._serialCurrentFrame.push(t),this._serialFrameState=x):(this._resetSerialFrameState(),6!==t&&4!==t||(this._serialFrameState=6===t?m:f,this._serialCurrentFrame=[t]));break;case p:case x:if(this._serialCurrentFrame.push(t),this._serialCurrentFrame.length>127){this._logger.error("Serial frame too long, dropping"),this._resetSerialFrameState();break}10===t&&(this._processSerialFrame(new Uint8Array(this._serialCurrentFrame)),this._resetSerialFrameState());break;default:this._resetSerialFrameState()}}_resetSerialFrameState(){this._serialFrameState=g,this._serialCurrentFrame=[]}_processSerialFrame(e){if(!e||e.length<3)return;const t=e[0]<<8|e[1],r=e.slice(2,e.length-1),s=this._uint8ToAscii(r),a=this._base64Decode(s);null!==a?this._handleSerialFragment(t,a):this._resetSerialPacketState()}_handleSerialFragment(e,t){if(!t)return void this._resetSerialPacketState();const r=this._serialRxContext;if(e===b)r.buffer=new Uint8Array,r.expectedLength=null;else{if(e!==y)return this._logger.error(`Unknown serial frame header: 0x${e.toString(16)}`),void this._resetSerialPacketState();if(null==r.expectedLength&&0===r.buffer.length)return this._logger.error("Received serial fragment without initial packet"),void this._resetSerialPacketState()}if(r.buffer=this._concatUint8Arrays(r.buffer,t),e===b){if(r.buffer.length<2)return;r.expectedLength=r.buffer[0]<<8|r.buffer[1],r.buffer=r.buffer.slice(2)}if(null==r.expectedLength)return;if(r.buffer.length<r.expectedLength)return;if(r.buffer.length>r.expectedLength)return this._logger.error("Serial packet buffer longer than expected length; dropping"),void this._resetSerialPacketState();const s=r.buffer,a=this._crc16(s);if(0!==a)return this._logger.error("Serial CRC mismatch (crc="+a+")"),void this._resetSerialPacketState();const i=s.slice(0,s.length-2);this._appendToMessageBuffer(i),this._resetSerialPacketState()}_resetSerialPacketState(){this._serialRxContext={buffer:new Uint8Array,expectedLength:null}}_concatUint8Arrays(e,t){const r=e||new Uint8Array,s=t||new Uint8Array;if(0===r.length)return s.slice();if(0===s.length)return r.slice();const a=new Uint8Array(r.length+s.length);return a.set(r,0),a.set(s,r.length),a}_crc16(e){let t=0;for(let r=0;r<e.length;r+=1){t^=e[r]<<8;for(let e=0;e<8;e+=1)t=32768&t?65535&(t<<1^4129):t<<1&65535}return 65535&t}_appendToMessageBuffer(e){if(e&&0!==e.length)for(this._buffer=new Uint8Array([...this._buffer,...e]);this._buffer.length>=8;){const e=256*this._buffer[2]+this._buffer[3];if(this._buffer.length<e+8)break;const t=this._buffer.slice(0,e+8);this._processMessage(t),this._buffer=this._buffer.slice(e+8)}}_processMessage(e){const[t,r,s,a,i,n,l,o]=e,d=u().decode(e.slice(8).buffer),c=256*s+a,h=256*i+n;if(1===h&&1===o&&(0===d.rc||void 0===d.rc)&&d.off)return this._uploadTimeout&&clearTimeout(this._uploadTimeout),this._uploadOffset=d.off,this._uploadIsInProgress&&this._uploadNext(),void(this._retryCount=0);if(8===h&&0===o){if((0===d.rc||void 0===d.rc)&&d.off)return this._uploadTimeout&&(clearTimeout(this._uploadTimeout),console.log("Upload timeout cleared")),this._uploadOffset=d.off,this._uploadIsInProgress&&this._uploadNextFileSystem(),void(this._retryCount=0);0!==d.rc&&(this._logger.error("Error uploading file:",d.rc),this._uploadTimeout&&(clearTimeout(this._uploadTimeout),console.log("Upload timeout cleared")),this._retryCount<3?(this._logger.info("Retrying upload..."),this._retryCount++,this._uploadNextFileSystem()):(this._logger.error("Upload failed after 3 retries"),this._uploadIsInProgress&&(this._fsUploadFinishedCallback(!1),this._uploadIsInProgress=!1)))}this._messageCallback&&this._messageCallback({op:t,group:h,id:o,data:d,length:c})}cmdReset(){return this._sendMessage(2,0,5)}smpEcho(e){return this._sendMessage(2,0,0,{d:e})}cmdImageState(){return this._sendMessage(0,1,0)}cmdImageErase(e){return void 0===e&&(e=1),this._sendMessage(2,1,5)}cmdImageTest(e){return this._sendMessage(2,1,0,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._sendMessage(2,1,0,{hash:e,confirm:!0})}cmdShellExec(e){let t=[];if(Array.isArray(e))t=e.filter((e=>"string"==typeof e&&e.length>0));else{if("string"!=typeof e)throw new Error("Shell command must be a string or array");t=e.trim().split(/\s+/).filter(Boolean)}return 0===t.length?Promise.resolve():this._sendMessage(2,9,0,{argv:t})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(this._uploadOffset>=this._uploadImage.byteLength||!this._uploadIsInProgress)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();this._uploadTimeout&&clearTimeout(this._uploadTimeout);const e=0===this._uploadOffset?this._firstChunkTimeout:this._chunkTimeout;this._uploadTimeout=setTimeout((()=>{this._logger.info("Upload chunk timeout, retry"),this._uploadNext()}),e);const t={data:new Uint8Array,off:this._uploadOffset,image:this._uploadImageNumber};0===this._uploadOffset&&(t.len=this._uploadImage.byteLength,t.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const r=this._mtu-u().encode(t).byteLength-8;t.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+r));try{await this._sendMessage(2,1,1,t)}catch(s){return this._logger.error("Error sending upload message:",s),void clearTimeout(this._uploadTimeout)}}async cmdUpload(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0),this._uploadIsInProgress?this._logger.error("Upload is already in progress."):(this._logger.info(`Starting upload of image ${t}...`),this._uploadIsInProgress=!0,this._logger.info(`Image size: ${e.byteLength} bytes`),this._logger.info(`MTU size: ${this._mtu} bytes`),this._uploadOffset=0,this._retryCount=0,this._uploadImage=e,this._uploadImageNumber=t,this._uploadSlot=r,this._uploadNext())}async imageInfo(e){const t={},r=new Uint8Array(e);if(r.length<32)throw new Error("Invalid image (too short file)");if(61!==r[0]||184!==r[1]||243!==r[2]||150!==r[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==r[4]||0!==r[5]||0!==r[6]||0!==r[7])throw new Error("Invalid image (wrong load address)");const s=r[8]+256*r[9];if(0!==r[10]||0!==r[11])throw new Error("Invalid image (wrong protected TLV area size)");const a=r[12]+256*r[13]+65536*r[14]+r[15]*2**24;if(t.imageSize=a,r.length<a+s)throw new Error("Invalid image (wrong image size)");if(0!==r[16]||0!==r[17]||0!==r[18]||0!==r[19])throw new Error("Invalid image (wrong flags)");const i=`${r[20]}.${r[21]}.${r[22]+256*r[23]}`;return t.version=i,t.hash=[...new Uint8Array(await this._hash(e.slice(0,a+s)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}async cmdUploadFileSystemImage(e,t){this._uploadIsInProgress?this._logger.error("Upload is already in progress."):(this._logger.info(`Starting upload of image to ${t}... of ${e.byteLength} bytes`),this._uploadIsInProgress=!0,this._logger.info(`Image size: ${e.byteLength} bytes`),this._logger.info(`MTU size: ${this._mtu} bytes`),this._uploadOffset=0,this._retryCount=0,this._uploadImage=e,this._uploadName=t,this._uploadNextFileSystem())}async _uploadNextFileSystem(){if(this._uploadOffset>=this._uploadImage.byteLength||!this._uploadIsInProgress)return this._uploadIsInProgress=!1,console.log("Upload finished"),void this._fsUploadFinishedCallback(!0);this._uploadTimeout&&clearTimeout(this._uploadTimeout);const e=0===this._uploadOffset?this._firstChunkTimeout:this._chunkTimeout;this._uploadTimeout=setTimeout((()=>{this._logger.info("Upload chunk timeout, retry"),this._uploadNextFileSystem()}),e);const t={data:new Uint8Array,off:this._uploadOffset,name:this._uploadName};0===this._uploadOffset&&(t.len=this._uploadImage.byteLength),this._fsUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});let r=this._netbuf_size-u().encode(t).byteLength-20;r-=r%4,console.log("File offset",this._uploadOffset),t.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+r));try{this._sendMessage(2,8,0,t)}catch(s){return this._logger.error("Error sending upload message:",s),void clearTimeout(this._uploadTimeout)}}};var _=r(797);const v={"app.internal.bin":0,"ipc_radio.bin":1,"app.external.bin":2},k={"app.internal.bin":1,"ipc_radio.bin":3,"app.external.bin":5},j="initial",N="connecting",S="connected";var C=r(1710),U=r.n(C);const F=(e,t)=>{const[r,a]=(0,s.useState)(null),[i,n]=(0,s.useState)(null),[l,o]=(0,s.useState)(!1),[d,c]=(0,s.useState)([]),[h,u]=(0,s.useState)("Select image files (.bin or dfu_application.zip)"),[g,m]=(0,s.useState)(!1),f=(0,s.useRef)(null),p=(0,s.useRef)(null),x=(0,s.useRef)(null),b=(0,s.useRef)(null),y=(0,s.useRef)(0),w=async r=>{if(!r)return void u("Ready to upload");let s=r.imageNumber;t&&void 0!==k[r.name]&&(s=k[r.name],console.log(`Serial recovery mode: Remapping ${r.name} from slot ${r.imageNumber} to slot ${s}`)),console.log("Starting upload for",r,"to image slot",s),o(!0),a(0),n(null),u("Uploading..."),b.current=r.fileSize,p.current=Date.now(),x.current=Date.now(),y.current=0;try{await e.cmdUpload(r.fileData,s),o(!1),c((e=>e.map((e=>e===r?{...e,isUploading:!0}:e))))}catch(i){u("Upload failed"),o(!1)}},_=async()=>{m(!0)};return{fileUploadPercentage:r,fileUploadSpeed:i,isFileUploadInProgress:l,fileInfos:d,fileStatus:h,setFileStatus:u,fileInputRef:f,handleFileChange:t=>{const r=t.target.files[0];if(!r)return void u("No file selected");u(`Processing ${r.name}...`);const s=new FileReader;s.onload=async()=>{"application/zip"===r.type?await(async(t,r)=>{const s=new(U());try{const t=await s.loadAsync(r.result),a=await Promise.all(Object.keys(t.files).filter((e=>e.endsWith(".bin"))).map((async r=>{const s=await t.files[r].async("arraybuffer"),a=v[r];if(null==a)return alert(`Invalid file: ${r}. Please use a valid binary file name.`),null;const i=await e.imageInfo(s);return{version:i.version,hash:i.hash,fileSize:s.byteLength,imageNumber:a,fileData:s,name:r,isUploaded:!1,isUploading:!1,isSetPending:!1,mcuMgrImageStatus:""}})));c((e=>[...e.filter((e=>!a.some((t=>t&&t.imageNumber===e.imageNumber)))),...a.filter((e=>null!==e))])),u("Zip file processed - Ready to upload")}catch(a){console.error("Error reading zip file:",a),u("Invalid zip file")}})(0,s):await(async(t,r)=>{let s=v[t.name];if(null==s&&(s=parseInt(prompt("Enter the image number:","0"),10),isNaN(s)||s<0))return alert("Invalid image number. Please enter a non-negative integer."),void u("Ready to upload");try{const a=await e.imageInfo(r.result);c((e=>[...e.filter((e=>e.imageNumber!==s)),{version:a.version,hash:a.hash,fileSize:r.result.byteLength,imageNumber:s,fileData:r.result,name:t.name,isUploaded:!1,isUploading:!1,isSetPending:!1,mcuMgrImageStatus:""}])),u("Binary file processed - Ready to upload")}catch(a){console.error("Error reading file:",a),u("Invalid image file")}})(r,s)},s.readAsArrayBuffer(r)},handleFileUpload:async()=>{if(d.length<=0)o(!1);else if(d[0].fileData){const e=d.find((e=>!e.isUploaded));e?w(e):(u("All files uploaded"),o(!1),_())}},clearFiles:()=>{c([]),u("Select image files (.bin or dfu_application.zip)"),f.current&&(f.current.value="")},setupUploadListeners:()=>{e&&(e.onImageUploadProgress((e=>{let{percentage:t}=e;u(`Uploading... ${t}%`),a(t);const r=Date.now(),s=(r-x.current)/1e3,i=t-y.current;if(i>0&&b.current){const e=i/100*b.current;n((e/1024/s).toFixed(2)),x.current=r,y.current=t}})),e.onImageUploadFinished((async()=>{u("Upload complete"),n(null),console.log("File upload finished",d);const r=d.find((e=>e.isUploading));if(c((e=>e.map((e=>e.isUploading?{...e,isUploaded:!0,isUploading:!1}:e)))),t&&r&&"ipc_radio.bin"===r.name){console.log("Net core uploaded, waiting 30 seconds for device to load it...");for(let e=30;e>0;e--)u(`Net core uploaded - waiting ${e}s for device to load...`),await new Promise((e=>setTimeout(e,1e3)));u("Net core loaded, ready for next upload")}const s=d.find((e=>!e.isUploaded&&!e.isUploading));s?w(s):(console.log("All files uploaded"),u("Upload complete"),e.cmdImageState(),_())})))},setFileInfos:c,showConfirmModal:g,handleConfirmationResponse:async r=>{if(m(!1),r&&!t){for(const t of d){const r=Uint8Array.from(t.hash.match(/.{1,2}/g).map((e=>parseInt(e,16))));await e.cmdImageConfirm(r)}await new Promise((e=>setTimeout(e,2e3))),await e.cmdReset()}}}},I=e=>{const[t,r]=(0,s.useState)([]),[a,i]=(0,s.useState)(!1);return{firmwares:t,isFetchingFirmwares:a,fetchAndSetFirmwares:async t=>{i(!0);const s=await async function(e,t){void 0===t&&(t=5);let r=[];try{const{owner:s,repo:a,token:i}=e,n=i?{headers:{Authorization:`Bearer ${i}`}}:{},[l,o]=await Promise.all([fetch(`https://api.github.com/repos/${s}/${a}/actions/runs?per_page=${Math.max(2*t,10)}`,n),fetch(`https://api.github.com/repos/${s}/${a}/actions/runs?branch=main&status=success&per_page=1`,n)]),d=await l.json(),c=await o.json(),h=d.workflow_runs||[],u=c.workflow_runs||[];if(0===h.length&&0===u.length)return console.log("No workflow runs found."),[];console.log("Found",h.length,"workflow runs.");const g=h.filter((e=>"success"===e.conclusion&&"gh-pages"!==e.head_branch)),m=u.find((e=>"success"===e.conclusion)),f=(m?[m,...g]:g).filter(((e,t,r)=>r.findIndex((t=>t.id===e.id))===t)).slice(0,t);console.log(`Fetching artifacts from ${f.length} workflow runs (main prioritized)...`);for(const e of f){console.log(`Processing workflow run: ${e.id} (${e.name})`,e);const t=e.head_sha||e.head_commit?.id||"",n=e.head_commit?.message||e.display_title||"",l=await fetch(`https://api.github.com/repos/${s}/${a}/actions/runs/${e.id}/artifacts`,i?{headers:{Authorization:`Bearer ${i}`}}:{}),o=await l.json();if(!o.artifacts||0===o.artifacts.length){console.log(`No artifacts found for workflow run: ${e.id}`);continue}const d={branch:e.head_branch,user:e.actor.login,runId:e.id,sha:t,commitMessage:n,createdAt:e.created_at,updatedAt:e.updated_at,artifacts:o.artifacts.filter((e=>e.name.includes("watchdk@1")||e.name.includes("@5")))};r.push(d)}}catch(s){console.error("Error fetching artifacts:",s)}return r}(e,t);console.log("Fetched firmwares:",s),s&&r(s),i(!1)},downloadAndFlashFirmware:async(t,r,s)=>{try{s("Downloading firmware..."),s("Firmware download started. Please check your browser's downloads."),((e,t,r)=>{const s=`https://github.com/${e.owner}/${e.repo}/actions/runs/${t}/artifacts/${r}`;console.log("Download URL:",s),window.location.href=s})(e,t,r)}catch(a){console.error("Error downloading or flashing firmware:",a),s("Failed to download firmware.")}}}},R=[{title:"General issues",items:["Press F12 and check console for errors","Reload the page"]},{title:"Connection issues",items:["Forget device in OS Bluetooth settings","Ensure watch is on","Use supported browser"]},{title:"Upload fails",items:["Reset watch, reload page and reconnect","Check file format (.zip or .bin)","Try switching to USB serial mode."]}],A=()=>{const e=(()=>{const{siteConfig:e}=(0,_.A)();return{owner:"ZSWatch",repo:"ZSWatch",token:e.customFields.githubToken||""}})(),{mcumgr:t,deviceName:r,screen:d,images:h,bluetoothAvailable:u,serialAvailable:g,transport:m,isSerialRecoveryMode:f,handleTransportChange:p,handleDeviceNameChange:x,handleConnect:b,handleDisconnect:y,registerShellListener:v}=(()=>{const[e,t]=(0,s.useState)("ZSWatch"),[r,a]=(0,s.useState)(j),[i,n]=(0,s.useState)([]),[l,o]=(0,s.useState)(!1),[d,c]=(0,s.useState)(!!navigator.serial),[h,u]=(0,s.useState)("serial"),[g,m]=(0,s.useState)(!0),f=(0,s.useRef)(new w({transport:"serial"})).current,p=(0,s.useRef)(new Set),x=(0,s.useCallback)((e=>{p.current.forEach((t=>{try{t(e)}catch(r){console.error("Shell listener callback failed",r)}}))}),[]),b=(0,s.useCallback)((e=>"function"!=typeof e?()=>{}:(p.current.add(e),()=>{p.current.delete(e)})),[]);return(0,s.useEffect)((()=>{(async()=>{try{const e=await(navigator.bluetooth?.getAvailability());o(!!e)}catch{o(!1)}})()}),[]),(0,s.useEffect)((()=>{f.onConnecting((()=>{a(N),m(!0)})),f.onConnect((()=>{t((e=>f.name||e)),f.cmdImageState()})),f.onDisconnect((()=>{a(j),m(!0),n([])})),f.onMessage((e=>{let{group:t,id:r,data:s,op:i}=e;switch(console.log("MCU Manager message:",{group:t,id:r,data:s}),t){case 0:switch(r){case 0:s?.rc&&0!==s.rc?alert(`Echo failed: Error code ${s.rc}`):alert(s?.r??"");break;case 2:console.table(s.tasks);break;case 3:console.log(s)}break;case 1:if(0===r){const e=s.images||[];if(n(e),console.log("Received image state:",e),a((e=>e===N?S:e)),e.length>0){const t=e[0],r=t.hasOwnProperty("confirmed")&&t.hasOwnProperty("pending")&&t.hasOwnProperty("hash");m(!r),console.log("Device mode detected:",r?"Full Application":"Serial Recovery (MCUBoot)")}}break;case 9:x({group:t,id:r,data:s,op:i});break;default:console.log("Unknown group")}}))}),[f,x]),(0,s.useEffect)((()=>{f.setTransport(h)}),[h,f]),(0,s.useEffect)((()=>{let e;e="serial"===h?g?500:100:500,f.setChunkTimeout(e),console.log(`Chunk timeout set to ${e}ms for ${h.toUpperCase()} transport in ${g?"Serial Recovery":"Application"} mode`)}),[g,h,f]),{mcumgr:f,deviceName:e,screen:r,images:i,bluetoothAvailable:l,serialAvailable:d,transport:h,isSerialRecoveryMode:g,setScreen:a,handleTransportChange:e=>{"ble"!==e&&"serial"!==e||(u(e),f.setTransport(e))},handleDeviceNameChange:e=>{t(e)},handleConnect:async()=>{if("serial"===h)return void await f.connect({transport:"serial"});const t=e?[{namePrefix:e}]:null;await f.connect({transport:"ble",filters:t})},handleDisconnect:async()=>{await f.disconnect()},registerShellListener:b}})(),k=(t?.isConnected?.()&&d===S)??!1,{fileUploadPercentage:C,fileUploadSpeed:U,isFileUploadInProgress:A,fileInfos:P,fileStatus:D,setFileStatus:L,fileInputRef:E,handleFileChange:T,handleFileUpload:z,setupUploadListeners:B,showConfirmModal:$,handleConfirmationResponse:M,waitingForNetCore:W,continueAfterNetCore:O}=F(t,f),[q,Z]=(0,s.useState)(0),[H,V]=(0,s.useState)(!1);(0,s.useEffect)((()=>{if(!W)return;let e=30;Z(e);const t=setInterval((()=>{e--,Z(e),e<=0&&(clearInterval(t),O())}),1e3);return()=>clearInterval(t)}),[W,O]);const{fileSystemUploadProgress:G,fileSystemUploadSpeed:K,fileSystemUploadStatus:Y,fileFsInputRef:J,handleFileSystemSelection:Q,startFileSystemUpload:X,setupFileSystemListeners:ee}=(e=>{const[t,r]=(0,s.useState)(null),[a,i]=(0,s.useState)(null),[n,l]=(0,s.useState)("Select a filesystem file"),[o,d]=(0,s.useState)(null),c=(0,s.useRef)(null),h=(0,s.useRef)(null),u=(0,s.useRef)(null),g=(0,s.useRef)(0);return{fileSystemUploadProgress:t,fileSystemUploadSpeed:a,fileSystemUploadStatus:n,fileFsInputRef:c,selectedFile:o,handleFileSystemSelection:e=>{const t=e.target.files[0];if(!t)return l("No file selected"),void d(null);console.log("Selected file:",t),d(t),l(`File selected: ${t.name} - Ready to upload`)},startFileSystemUpload:async()=>{if(!o)return void l("No file selected");const t=new FileReader;t.onload=async s=>{l("Uploading..."),r(0),i(null),u.current=o.size,h.current=Date.now(),g.current=0;try{await e.cmdUploadFileSystemImage(t.result,"/S/full_fs"),l("Upload started")}catch(a){console.error("Filesystem upload failed:",a),l("Upload failed"),r(null),i(null)}c.current.value=null,d(null)},t.readAsArrayBuffer(o)},setupFileSystemListeners:()=>{e&&(e.onFsUploadProgress((e=>{let{percentage:t}=e;r(t),l(`Uploading... ${t}%`);const s=Date.now(),a=(s-h.current)/1e3,n=t-g.current;if(n>0&&u.current){const e=n/100*u.current;i((e/1024/a).toFixed(2)),h.current=s,g.current=t}})),e.onFsUploadFinished((e=>{l(e?"Upload complete":"Upload failed"),r(null),i(null)})))}}})(t),{firmwares:te,isFetchingFirmwares:re,fetchAndSetFirmwares:se,downloadAndFlashFirmware:ae}=I(e);(0,s.useEffect)((()=>{t&&(B(),ee())}),[B,ee,t]);const ie=(e,t)=>{ae(e,t,L)},ne=()=>{const e=prompt("Enter a text message to send","Hello World!");e&&t&&t.smpEcho(e)},le=()=>{t&&t.cmdReset()},oe=()=>{if(!t||!h||0===h.length)return void alert("No images available to confirm");h.filter((e=>!1===e.confirmed)).forEach((e=>{e.hash&&(console.log("Confirming unconfirmed image with hash:",e.hash),t.cmdImageConfirm(e.hash))}))},de=()=>{const e=d===N,s="ble"===m?u:g,a="ble"===m?"BLE":"USB Serial";return(0,i.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-8 xl:grid-cols-11 gap-6",children:[(0,i.jsxs)("div",{className:"lg:col-span-2 xl:col-span-3 space-y-6",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Connection"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsxs)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:[(0,i.jsx)("div",{className:"flex items-center justify-between mb-4",children:(0,i.jsx)("div",{className:"px-2 py-1 rounded-full text-xs font-medium "+(k?"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300":e?"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 animate-pulse":"bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300"),children:k?`Connected (${a})`:e?"Connecting...":"Disconnected"})}),(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Connection method"}),(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsx)("button",{type:"button",disabled:k||e,onClick:()=>p("ble"),className:"flex-1 px-3 py-2 text-sm rounded-lg border transition-all disabled:opacity-50 disabled:cursor-not-allowed "+("ble"===m?"bg-zswatch-primary text-black border-zswatch-primary":"bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-white/10 hover:bg-gray-200 dark:hover:bg-white/20"),children:"Bluetooth"}),(0,i.jsx)("button",{type:"button",disabled:k||e,onClick:()=>p("serial"),className:"flex-1 px-3 py-2 text-sm rounded-lg border transition-all disabled:opacity-50 disabled:cursor-not-allowed "+("serial"===m?"bg-zswatch-primary text-black border-zswatch-primary":"bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-white/10 hover:bg-gray-200 dark:hover:bg-white/20"),children:"USB Serial"})]}),(0,i.jsxs)("div",{className:"mt-2 flex flex-wrap gap-3 text-xs text-gray-500 dark:text-gray-400",children:[(0,i.jsxs)("span",{className:u?"text-green-600 dark:text-green-300":"text-red-500 dark:text-red-400",children:["BLE: ",u?"Available":"Unavailable"]}),(0,i.jsxs)("span",{className:g?"text-green-600 dark:text-green-300":"text-red-500 dark:text-red-400",children:["USB Serial: ",g?"Available":"Unavailable"]})]})]}),!s&&(0,i.jsxs)("div",{className:"p-3 rounded-lg border bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800",children:[(0,i.jsxs)("div",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"mr-2",children:"\u274c"}),(0,i.jsxs)("span",{className:"text-sm font-medium text-red-800 dark:text-red-300",children:["ble"===m?"Bluetooth (BLE)":"USB Serial (WebSerial)"," Unavailable"]})]}),(0,i.jsx)("p",{className:"mt-2 mb-0 text-xs leading-relaxed text-red-700 dark:text-red-300",children:"ble"===m?"Requires a browser with Web Bluetooth support (Chrome, Edge, Opera).":"Requires Web Serial support (Chrome or Edge)."})]}),(0,i.jsxs)("div",{className:"p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800",children:[(0,i.jsxs)("div",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"mr-2",children:"\ud83d\udca1"}),(0,i.jsx)("span",{className:"text-sm font-medium text-blue-800 dark:text-blue-300",children:"Enable Firmware Updates"})]}),(0,i.jsxs)("p",{className:"mt-2 mb-0 text-xs leading-relaxed text-blue-700 dark:text-blue-200",children:["Go to ZSWatch ",(0,i.jsxs)("b",{children:["System ","->"," Update App"]})," and enable either USB or Bluetooth.",(0,i.jsx)("b",{children:" USB is significantly faster than Bluetooth"})," due to Web Bluetooth API limitations.",(0,i.jsx)("br",{}),(0,i.jsx)("br",{}),(0,i.jsx)("b",{children:"Serial Recovery:"})," If ZSWatch is not responding enter MCUBoot by holding down two right buttons for 25 seconds."]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Device name"}),(0,i.jsx)("input",{type:"text",value:r,onChange:e=>x(e.target.value),disabled:"ble"!==m||k||!u,className:"w-full bg-white dark:bg-black/30 border border-gray-300 dark:border-white/20 rounded-lg px-3 py-2 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-zswatch-primary focus:outline-none focus:ring-2 focus:ring-zswatch-primary/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-sm",placeholder:"ZSWatch"}),(0,i.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"ble"===m?"Optional prefix filter. Leave empty to scan for any compatible device.":"Not required when connecting over USB."})]}),(0,i.jsxs)("div",{className:"flex flex-col gap-2",children:[k?(0,i.jsxs)("button",{onClick:y,className:"flex items-center justify-center gap-2 px-4 py-2 bg-red-100 dark:bg-red-500/20 text-red-700 dark:text-red-400 rounded-lg border border-red-300 dark:border-red-500/30 hover:bg-red-200 dark:hover:bg-red-500/30 transition-all",children:[(0,i.jsx)("span",{className:"text-sm",children:"\ud83d\udd0c"}),"Disconnect"]}):(0,i.jsx)("button",{onClick:b,disabled:!s||e,className:"px-4 py-2 bg-zswatch-primary text-black rounded-lg font-medium hover:bg-zswatch-primary/90 transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:e?"Connecting...":"ble"===m?"Connect via BLE":"Connect via Serial"}),k&&(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsxs)("button",{onClick:ne,className:"flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white rounded-lg border border-gray-300 dark:border-white/20 hover:bg-gray-200 dark:hover:bg-white/20 transition-all text-sm",children:[(0,i.jsx)("span",{className:"text-xs",children:"\ud83d\udce2"}),"Echo"]}),(0,i.jsxs)("button",{onClick:le,className:"flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white rounded-lg border border-gray-300 dark:border-white/20 hover:bg-gray-200 dark:hover:bg-white/20 transition-all text-sm",children:[(0,i.jsx)("span",{className:"text-xs",children:"\ud83d\udd04"}),"Reset"]})]})]})]})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Browser Support"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:(0,i.jsxs)("ul",{className:"space-y-2 text-sm text-gray-600 dark:text-gray-300",style:{paddingLeft:0,paddingInlineStart:0,margin:0},children:[(0,i.jsxs)("li",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-3"}),"Chrome, Edge, Opera (Desktop)"]}),(0,i.jsxs)("li",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-3"}),"Chrome, Edge (WebSerial / USB serial updates)"]}),(0,i.jsxs)("li",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-3"}),"Chrome (Android)"]}),(0,i.jsxs)("li",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"w-2 h-2 bg-yellow-500 rounded-full mr-3"}),"Bluefy (iOS/iPadOS)"]})]})})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Troubleshooting"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:(0,i.jsx)("div",{className:"space-y-3",children:R.map(((e,t)=>(0,i.jsxs)("details",{className:"group",children:[(0,i.jsxs)("summary",{className:"flex items-center justify-between cursor-pointer text-gray-900 dark:text-white hover:text-zswatch-primary transition-colors text-sm",children:[(0,i.jsx)("span",{children:e.title}),(0,i.jsx)("span",{className:"group-open:rotate-180 transition-transform",children:"\u25bc"})]}),(0,i.jsx)("div",{className:"mt-3 space-y-2 text-xs text-gray-600 dark:text-gray-300 pl-4 border-l-2 border-zswatch-primary/30",children:e.items.map(((e,t)=>(0,i.jsxs)("p",{className:"m-0",children:["\u2022 ",e]},t)))})]},t)))})})]})]}),(0,i.jsxs)("div",{className:"lg:col-span-3 xl:col-span-4 space-y-6",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Manual Upload"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-4 shadow-sm",children:(0,i.jsx)(l,{fileInputRef:E,fileStatus:D,fileUploadPercentage:C,fileUploadSpeed:U,fileInfos:P,isFileUploadInProgress:A,onFileChange:T,onFileUpload:z,onEraseFiles:()=>t&&t.cmdImageErase(),onConfirmFiles:()=>t&&t.cmdImageConfirm(),isConnected:k,isSerialRecoveryMode:f})})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"File System"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-4 shadow-sm",children:(0,i.jsx)(o,{fileFsInputRef:J,fileSystemUploadStatus:Y,fileSystemUploadProgress:G,fileSystemUploadSpeed:K,onFileSystemSelection:Q,onFileSystemUploadStart:X,isConnected:k,isSerialRecoveryMode:f})})]})]}),(0,i.jsxs)("div",{className:"lg:col-span-3 xl:col-span-4 space-y-6",children:[(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Shell Console"}),(0,i.jsx)("button",{type:"button",onClick:()=>V(!0),className:"px-3 py-2 text-xs font-medium rounded-md border border-gray-300 dark:border-white/20 text-gray-700 dark:text-gray-200 bg-white dark:bg-white/10 hover:bg-gray-100 dark:hover:bg-white/20 transition-all",children:"Open in Modal"})]}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsx)(c,{mcumgr:t,registerShellListener:v,isConnected:k})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Prebuilt Firmware"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsxs)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:[(0,i.jsx)("div",{className:"flex items-center justify-between mb-4",children:(0,i.jsxs)("button",{onClick:()=>se(6),disabled:re,className:"bg-zswatch-secondary/20 text-zswatch-secondary border border-zswatch-secondary/30 px-3 py-1 rounded text-sm hover:bg-zswatch-secondary/30 transition-all flex items-center gap-1",children:[(0,i.jsx)("span",{className:"text-xs",children:"\ud83d\udd04"}),re?"Fetching...":"Fetch Latest"]})}),(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-300 text-sm mb-2",children:"Download the latest firmware from GitHub Actions."}),(0,i.jsxs)("div",{className:"p-3 mb-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 text-xs text-blue-800 dark:text-blue-200 space-y-1",children:[(0,i.jsxs)("p",{className:"m-0",children:[(0,i.jsx)("strong",{children:"Note:"})," Downloading GitHub Actions artifacts requires you to be logged in to GitHub."]}),(0,i.jsxs)("p",{className:"m-0",children:[(0,i.jsx)("strong",{children:"After downloading:"})," The downloaded file is a zip archive. Extract it to find:"]}),(0,i.jsxs)("p",{className:"m-0",children:["\u2022 ",(0,i.jsx)("code",{children:"dfu_application.zip"})," \u2014 upload this in ",(0,i.jsx)("strong",{children:"Manual Upload"})," to flash firmware"]}),(0,i.jsxs)("p",{className:"m-0",children:["\u2022 ",(0,i.jsx)("code",{children:"lvgl_resources_raw.bin"})," \u2014 upload this in ",(0,i.jsx)("strong",{children:"File System"})," to update icons/graphics"]})]}),(0,i.jsx)(n,{firmwares:te,isFetchingFirmwares:re,onFetchFirmwares:se,onDownloadFirmware:ie,isConnected:k})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-1",children:"Images"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-2"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:k?h&&h.length>0?(0,i.jsxs)("div",{className:"space-y-0",children:[h.map(((e,t)=>(0,i.jsx)("div",{className:"border rounded p-2 "+(e.active?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-500/30":"border-gray-200 dark:border-white/10"),children:(0,i.jsxs)("div",{className:"flex items-start justify-between",children:[(0,i.jsxs)("div",{className:"flex-1",children:[(0,i.jsxs)("h4",{className:"font-medium text-gray-900 dark:text-white text-sm m-0 mb-1",children:["Image #",e.image," - Slot ",e.slot]}),(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0 text-xs text-gray-500 dark:text-gray-400",children:[(0,i.jsxs)("div",{children:["Version: ",e.version||"Unknown"]}),(0,i.jsx)("div",{children:e.bootable?"Bootable":"Not Bootable"}),(0,i.jsxs)("div",{children:["Confirmed: ",e.confirmed?"Yes":"No"]}),(0,i.jsxs)("div",{children:["Pending: ",e.pending?"Yes":"No"]})]}),e.hash&&(0,i.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 font-mono mt-1",children:["Hash: ",Array.from(e.hash).map((e=>e.toString(16).padStart(2,"0"))).join("").substring(0,16),"..."]})]}),(0,i.jsxs)("div",{className:"flex flex-wrap gap-1 ml-2",children:[e.active&&(0,i.jsx)("span",{className:"text-xs bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400 px-2 py-0.5 rounded",children:"\u2705 Active"}),e.pending&&(0,i.jsx)("span",{className:"text-xs bg-yellow-100 dark:bg-yellow-500/20 text-yellow-700 dark:text-yellow-400 px-2 py-0.5 rounded",children:"\u23f3 Pending"}),e.confirmed&&(0,i.jsx)("span",{className:"text-xs bg-blue-100 dark:bg-blue-500/20 text-blue-700 dark:text-blue-400 px-2 py-0.5 rounded",children:"\u2713 Confirmed"}),e.permanent&&(0,i.jsx)("span",{className:"text-xs bg-purple-100 dark:bg-purple-500/20 text-purple-700 dark:text-purple-400 px-2 py-0.5 rounded",children:"\ud83d\udccc Permanent"})]})]})},t))),(0,i.jsxs)("div",{className:"flex gap-2 pt-3 border-t border-gray-200 dark:border-white/10",children:[(0,i.jsx)("button",{onClick:()=>t&&t.cmdImageState(),className:"flex-1 bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white px-3 py-2 rounded text-sm hover:bg-gray-200 dark:hover:bg-white/20 transition-all",children:"Refresh"}),!f&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{onClick:()=>t&&t.cmdImageTest(),className:"flex-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-2 rounded text-sm hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-all",children:"Test"}),(0,i.jsx)("button",{onClick:oe,className:"flex-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-2 rounded text-sm hover:bg-green-200 dark:hover:bg-green-900/50 transition-all",children:"Confirm"}),(0,i.jsx)("button",{onClick:()=>t&&t.cmdImageErase(),className:"flex-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 px-3 py-2 rounded text-sm hover:bg-red-200 dark:hover:bg-red-900/50 transition-all",children:"Erase"})]})]}),f?(0,i.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2 flex items-center",children:[(0,i.jsx)("span",{className:"mr-1",children:"\u2139\ufe0f"}),"Updates flash directly in MCUBoot mode. Reset device to boot new firmware."]}):(0,i.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2 flex items-center",children:[(0,i.jsx)("span",{className:"mr-1",children:"\u2139\ufe0f"}),"Use Test/Confirm/Erase to manage firmware images"]})]}):(0,i.jsxs)("div",{className:"text-center py-6",children:[(0,i.jsx)("div",{className:"text-gray-400 text-2xl mb-2",children:"\ud83d\udcf1"}),(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-300 text-sm",children:"No images found on device"})]}):(0,i.jsxs)("div",{className:"text-center py-6",children:[(0,i.jsx)("div",{className:"text-amber-500 text-2xl mb-2",children:"\u26a0\ufe0f"}),(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-300 text-sm",children:"Connect to device to view image status"})]})})]})]})]})};return(0,i.jsxs)(a.A,{children:[(0,i.jsx)("div",{className:"min-h-screen zswatch-background-gradient",children:(0,i.jsxs)("div",{className:"container mx-auto px-2 py-8",children:[(0,i.jsxs)("div",{className:"text-center mb-8",children:[(0,i.jsx)("h1",{className:"text-4xl font-bold mb-2 text-gray-900 dark:text-gray-100",children:"ZSWatch Firmware Update"}),(0,i.jsx)("p",{className:"text-lg text-gray-600 dark:text-gray-300 mb-4",children:"Update your ZSWatch firmware and image resources over USB or Bluetooth"}),(0,i.jsxs)("details",{className:"inline-block text-left max-w-2xl mx-auto",children:[(0,i.jsx)("summary",{className:"cursor-pointer text-sm font-medium text-zswatch-primary hover:underline",children:"How does this work?"}),(0,i.jsxs)("div",{className:"mt-3 p-4 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-sm text-gray-700 dark:text-gray-300 space-y-2",children:[(0,i.jsxs)("p",{className:"m-0",children:[(0,i.jsx)("strong",{children:"Step 1:"})," On your ZSWatch, go to ",(0,i.jsx)("strong",{children:"Apps \u2192 Update"})," and enable ",(0,i.jsx)("strong",{children:"USB"})," or ",(0,i.jsx)("strong",{children:"BLE"}),"."]}),(0,i.jsxs)("p",{className:"m-0",children:[(0,i.jsx)("strong",{children:"Step 2:"})," Connect to the watch using the ",(0,i.jsx)("strong",{children:"Connection"})," panel on the left. USB is much faster than BLE."]}),(0,i.jsxs)("p",{className:"m-0",children:[(0,i.jsx)("strong",{children:"Step 3 \u2013 Firmware:"})," Use ",(0,i.jsx)("strong",{children:"Prebuilt Firmware"})," to fetch the latest build matching your hardware. To flash, extract the ",(0,i.jsx)("code",{children:".zip"})," file you downloaded, then upload the ",(0,i.jsx)("code",{children:"dfu_application.zip"}),"."]}),(0,i.jsxs)("p",{className:"m-0",children:[(0,i.jsx)("strong",{children:"Step 4 \u2013 Image Resources:"})," Upload ",(0,i.jsx)("code",{children:"lvgl_resources_raw.bin"})," in the ",(0,i.jsx)("strong",{children:"File System"})," section so icons and graphics display correctly. This file is included in the firmware download package."]}),(0,i.jsxs)("p",{className:"m-0 text-xs text-gray-500 dark:text-gray-400",children:["Firmware downloads are available from ",(0,i.jsx)("a",{href:"https://github.com/ZSWatch/ZSWatch/releases",target:"_blank",rel:"noopener noreferrer",className:"underline",children:"GitHub Releases"})," and ",(0,i.jsx)("a",{href:"https://github.com/ZSWatch/ZSWatch/actions",target:"_blank",rel:"noopener noreferrer",className:"underline",children:"GitHub Actions"}),"."]})]})]})]}),(0,i.jsx)("div",{className:"px-2 pb-8 max-w-7xl mx-auto",children:de()})]})}),H&&(0,i.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",onClick:()=>V(!1),children:[(0,i.jsx)("div",{className:"absolute inset-0 bg-black/60"}),(0,i.jsx)("div",{className:"relative z-10 w-full max-w-5xl",onClick:e=>e.stopPropagation(),children:(0,i.jsxs)("div",{className:"bg-white dark:bg-gray-900 rounded-lg shadow-2xl overflow-hidden",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-white/10",children:[(0,i.jsx)("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white m-0",children:"Shell Console"}),(0,i.jsx)("button",{type:"button",onClick:()=>V(!1),className:"text-gray-500 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white transition",children:"\u2715"})]}),(0,i.jsx)("div",{className:"p-4",children:(0,i.jsx)(c,{mcumgr:t,registerShellListener:v,isConnected:k,className:"shadow-none p-0 bg-transparent",textareaClassName:"h-[28rem] text-sm"})})]})})]}),$&&(0,i.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,i.jsx)("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md mx-4",children:f?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("h3",{className:"text-xl font-bold mb-4 text-gray-900 dark:text-gray-100",children:"Firmware Uploaded"}),q>0?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-300 mb-2",children:"Net core image uploaded successfully. Waiting for device to load it..."}),(0,i.jsxs)("div",{className:"text-center my-4",children:[(0,i.jsxs)("div",{className:"text-4xl font-bold text-blue-600 dark:text-blue-400",children:[q,"s"]}),(0,i.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-2",children:"Please wait while the device initializes"})]})]}):(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-300 mb-6",children:"Update complete. Reset the device to boot the new firmware."}),(0,i.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,i.jsx)("button",{onClick:()=>M(!1),disabled:q>0,className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Close"}),(0,i.jsx)("button",{onClick:()=>{le(),M(!1)},disabled:q>0,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Reset Now"})]})]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("h3",{className:"text-xl font-bold mb-4 text-gray-900 dark:text-gray-100",children:"Confirm Firmware Images"}),(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-300 mb-6",children:"Do you want to confirm the uploaded images and restart the device? It will take about 30s to reboot and apply the new firmware. Be patient."}),(0,i.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,i.jsx)("button",{onClick:()=>M(!1),className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors",children:"Cancel"}),(0,i.jsx)("button",{onClick:()=>M(!0),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"Confirm"})]})]})})})]})}}}]);
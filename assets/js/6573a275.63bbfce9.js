(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[6019],{1909:function(e,t,r){var s,a;!function(i,n){"use strict";var l=4294967296,o=9007199254740992;(a="function"==typeof(s={encode:function(e){var t,r=new ArrayBuffer(256),s=new DataView(r),a=0;function i(e){for(var i=r.byteLength,n=a+e;i<n;)i<<=1;if(i!==r.byteLength){var l=s;r=new ArrayBuffer(i),s=new DataView(r);for(var o=a+3>>2,d=0;d<o;++d)s.setUint32(d<<2,l.getUint32(d<<2))}return t=e,s}function d(){a+=t}function c(e){d(i(1).setUint8(a,e))}function h(e){for(var t=i(e.length),r=0;r<e.length;++r)t.setUint8(a+r,e[r]);d()}function g(e,t){t<24?c(e<<5|t):t<256?(c(e<<5|24),c(t)):t<65536?(c(e<<5|25),function(e){d(i(2).setUint16(a,e))}(t)):t<4294967296?(c(e<<5|26),function(e){d(i(4).setUint32(a,e))}(t)):(c(e<<5|27),function(e){var t=e%l,r=(e-t)/l,s=i(8);s.setUint32(a,r),s.setUint32(a+4,t),d()}(t))}if(function e(t){var r;if(!1===t)return c(244);if(!0===t)return c(245);if(null===t)return c(246);if(t===n)return c(247);switch(typeof t){case"number":if(Math.floor(t)===t){if(0<=t&&t<=o)return g(0,t);if(-o<=t&&t<0)return g(1,-(t+1))}return c(251),function(e){d(i(8).setFloat64(a,e))}(t);case"string":var s=[];for(r=0;r<t.length;++r){var l=t.charCodeAt(r);l<128?s.push(l):l<2048?(s.push(192|l>>6),s.push(128|63&l)):l<55296?(s.push(224|l>>12),s.push(128|l>>6&63),s.push(128|63&l)):(l=(1023&l)<<10,l|=1023&t.charCodeAt(++r),l+=65536,s.push(240|l>>18),s.push(128|l>>12&63),s.push(128|l>>6&63),s.push(128|63&l))}return g(3,s.length),h(s);default:var u;if(Array.isArray(t))for(g(4,u=t.length),r=0;r<u;++r)e(t[r]);else if(t instanceof Uint8Array)g(2,t.length),h(t);else{var m=Object.keys(t);for(g(5,u=m.length),r=0;r<u;++r){var f=m[r];e(f),e(t[f])}}}}(e),"slice"in r)return r.slice(0,a);for(var u=new ArrayBuffer(a),m=new DataView(u),f=0;f<a;++f)m.setUint8(f,s.getUint8(f));return u},decode:function(e,t,r){var s=new DataView(e),a=0;function i(e,t){return a+=e,t}function o(t){return i(t,new Uint8Array(e,a,t))}function d(){return i(1,s.getUint8(a))}function c(){return i(2,s.getUint16(a))}function h(){return i(4,s.getUint32(a))}function g(){return 255===s.getUint8(a)&&(a+=1,!0)}function u(e){if(e<24)return e;if(24===e)return d();if(25===e)return c();if(26===e)return h();if(27===e)return h()*l+h();if(31===e)return-1;throw"Invalid length encoding"}function m(e){var t=d();if(255===t)return-1;var r=u(31&t);if(r<0||t>>5!==e)throw"Invalid indefinite length element";return r}function f(e,t){for(var r=0;r<t;++r){var s=d();128&s&&(s<224?(s=(31&s)<<6|63&d(),t-=1):s<240?(s=(15&s)<<12|(63&d())<<6|63&d(),t-=2):(s=(15&s)<<18|(63&d())<<12|(63&d())<<6|63&d(),t-=3)),s<65536?e.push(s):(s-=65536,e.push(55296|s>>10),e.push(56320|1023&s))}}"function"!=typeof t&&(t=function(e){return e}),"function"!=typeof r&&(r=function(){return n});var p=function e(){var l,h,p=d(),x=p>>5,b=31&p;if(7===x)switch(b){case 25:return function(){var e=new ArrayBuffer(4),t=new DataView(e),r=c(),s=32768&r,a=31744&r,i=1023&r;if(31744===a)a=261120;else if(0!==a)a+=114688;else if(0!==i)return(s?-1:1)*i*5.960464477539063e-8;return t.setUint32(0,s<<16|a<<13|i<<13),t.getFloat32(0)}();case 26:return i(4,s.getFloat32(a));case 27:return i(8,s.getFloat64(a))}if((h=u(b))<0&&(x<2||6<x))throw"Invalid length";switch(x){case 0:return h;case 1:return-1-h;case 2:if(h<0){for(var y=[],_=0;(h=m(x))>=0;)_+=h,y.push(o(h));var w=new Uint8Array(_),v=0;for(l=0;l<y.length;++l)w.set(y[l],v),v+=y[l].length;return w}return o(h);case 3:var k=[];if(h<0)for(;(h=m(x))>=0;)f(k,h);else f(k,h);return String.fromCharCode.apply(null,k);case 4:var N;if(h<0)for(N=[];!g();)N.push(e());else for(N=new Array(h),l=0;l<h;++l)N[l]=e();return N;case 5:var j={};for(l=0;l<h||h<0&&!g();++l){j[e()]=e()}return j;case 6:return t(e(),h);case 7:switch(h){case 20:return!1;case 21:return!0;case 22:return null;case 23:return n;default:return r(h)}}}();if(a!==e.byteLength)throw"Remaining bytes";return p}})?s.call(t,r,t,e):s)===n||(e.exports=a)}()},7277:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>F});var s=r(6540),a=r(6393),i=r(4848);const n=e=>{let{firmwares:t,isFetchingFirmwares:r,onFetchFirmwares:a,onDownloadFirmware:n,isConnected:l=!1}=e;const[o,d]=(0,s.useState)({}),c=t.reduce(((e,t)=>(e[t.branch]||(e[t.branch]=[]),e[t.branch].push(t),e)),{});return(0,i.jsx)("div",{className:"space-y-3",children:r?(0,i.jsxs)("div",{className:"text-center py-6",children:[(0,i.jsx)("div",{className:"inline-flex items-center justify-center w-6 h-6 bg-zswatch-secondary rounded-full animate-spin mb-2",children:(0,i.jsx)("span",{className:"text-white text-xs",children:"\u23f3"})}),(0,i.jsx)("p",{className:"text-gray-700 dark:text-white text-sm",children:"Loading firmwares..."})]}):0===t.length?(0,i.jsxs)("div",{className:"text-center py-6 bg-gray-50 dark:bg-black/20 border border-gray-200 dark:border-white/10 rounded-lg",children:[(0,i.jsx)("span",{className:"text-2xl mb-2 block",children:"\ud83d\udce6"}),(0,i.jsx)("p",{className:"text-gray-700 dark:text-white text-sm",children:"No firmwares fetched yet"}),(0,i.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:'Click "Fetch Latest" to get builds'})]}):(0,i.jsx)("div",{className:"space-y-2",children:Object.entries(c).map((e=>{let[t,r]=e;return(0,i.jsxs)("div",{className:"border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden",children:[(0,i.jsx)("div",{className:"bg-gray-50 dark:bg-black/20 px-3 py-2 border-b border-gray-200 dark:border-white/10",children:(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t}),"main"===t&&(0,i.jsx)("span",{className:"text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-2 py-1 rounded-full",children:"Release"}),"main"!==t&&(0,i.jsx)("span",{className:"text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-1 rounded-full",children:"Debug"})]}),(0,i.jsxs)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:[r.length," build",1!==r.length?"s":""]})]})}),(0,i.jsx)("div",{className:"space-y-1",children:r.map(((e,r)=>{const s=`${t}-${r}`;return(0,i.jsxs)("div",{className:"border-b border-gray-100 dark:border-white/5 last:border-b-0",children:[(0,i.jsxs)("button",{onClick:()=>(e=>{d((t=>({...t,[e]:!t[e]})))})(s),className:"w-full flex items-center justify-between p-2 bg-gray-100 dark:bg-white/10 hover:bg-gray-200 dark:hover:bg-white/15 transition-all",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 text-left",children:[(0,i.jsxs)("span",{className:"text-xs text-gray-600 dark:text-gray-300",children:["by ",e.user]}),(0,i.jsxs)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:[e.artifacts.length," artifact",1!==e.artifacts.length?"s":""]})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:["main"===t&&0===r&&(0,i.jsx)("button",{onClick:t=>{t.stopPropagation(),e.artifacts.length>0&&n(e.runId,e.artifacts[0].id)},className:"bg-zswatch-primary text-black px-2 py-1 rounded text-xs font-medium hover:bg-zswatch-primary/90 transition-all",children:"Quick Download"}),(0,i.jsx)("span",{className:"text-xs transition-transform "+(o[s]?"rotate-180":""),children:"\u25bc"})]})]}),o[s]&&(0,i.jsx)("div",{className:"px-3 pb-2",children:(0,i.jsx)("div",{className:"space-y-1",children:e.artifacts.map(((t,r)=>(0,i.jsxs)("div",{className:"flex items-center justify-between p-2 bg-gray-50 dark:bg-white/5 hover:bg-gray-100 dark:hover:bg-white/10 rounded border border-gray-200 dark:border-white/10 transition-colors",children:[(0,i.jsx)("span",{className:"text-xs text-gray-700 dark:text-gray-300 font-mono",children:t.name}),(0,i.jsx)("button",{onClick:()=>n(e.runId,t.id),className:"bg-zswatch-primary text-black px-2 py-1 rounded text-xs font-medium hover:bg-zswatch-primary/90 transition-all",children:"Download"})]},r)))})})]},r)}))})]},t)}))})})},l=e=>{let{fileInputRef:t,fileStatus:r,fileUploadPercentage:a,fileUploadSpeed:n,fileInfos:l,isFileUploadInProgress:o,onFileChange:d,onFileUpload:c,onEraseFiles:h,onConfirmFiles:g,onClearFiles:u,isConnected:m=!1}=e;const[f,p]=s.useState(!1);return(0,i.jsxs)("div",{className:"space-y-6",children:[(0,i.jsxs)("div",{className:"relative",children:[(0,i.jsx)("input",{type:"file",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",onChange:d,ref:t,accept:".zip,.bin"}),(0,i.jsx)("div",{className:`\n            relative border-2 border-dashed rounded-xl p-4 text-center transition-all duration-200\n            ${f?"border-zswatch-primary bg-zswatch-primary/5 scale-105":"border-gray-300 dark:border-gray-600 hover:border-zswatch-primary/50 hover:bg-zswatch-primary/5"}\n          `,onDragOver:e=>{e.preventDefault(),p(!0)},onDragLeave:e=>{e.preventDefault(),p(!1)},onDrop:e=>{if(e.preventDefault(),p(!1),e.dataTransfer.files.length>0){const t={target:{files:e.dataTransfer.files}};d(t)}},children:(0,i.jsxs)("div",{className:"transition-all duration-200 "+(f?"scale-110":""),children:[(0,i.jsx)("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:f?"Drop your files here":"Upload Firmware Files"}),(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Drag and drop your .bin or .zip files here"})]})})]}),null!==a&&(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,i.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:"Upload Progress"}),(0,i.jsxs)("span",{className:"font-medium text-gray-900 dark:text-white",children:[a,"%"]})]}),(0,i.jsx)("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:(0,i.jsx)("div",{className:"bg-gradient-to-r from-zswatch-secondary to-zswatch-primary h-3 rounded-full transition-all duration-300 relative overflow-hidden",style:{width:`${a}%`},children:(0,i.jsx)("div",{className:"absolute inset-0 bg-white/20 animate-pulse"})})}),n&&(0,i.jsxs)("p",{className:"text-sm text-gray-600 dark:text-gray-400 text-right",children:[n," KB/s"]})]}),l&&l.length>0&&(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsxs)("h4",{className:"text-sm font-medium text-gray-900 dark:text-white",children:["\ud83d\udccb Files (",l.length,")",r&&"Select image files (.bin or .zip)"!==r&&(0,i.jsxs)("span",{className:"ml-2 text-xs text-gray-600 dark:text-gray-400",children:["- ",r]})]})}),(0,i.jsx)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-3",children:l.map(((e,t)=>{return(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-lg p-3",children:(0,i.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,i.jsxs)("div",{className:"flex items-start gap-2 min-w-0 flex-1",children:[(0,i.jsx)("span",{className:"text-sm mt-0.5",children:"\ud83d\udcc4"}),(0,i.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,i.jsx)("h5",{className:"font-medium text-gray-900 dark:text-white text-sm truncate mb-1",children:e.name}),(0,i.jsxs)("div",{className:"space-y-1",children:[(0,i.jsxs)("div",{className:"flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400",children:[(0,i.jsxs)("span",{className:"bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded",children:["Image #",e.imageNumber]}),(0,i.jsxs)("span",{children:["v",e.version]})]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:(r=e.fileSize,(r/1024).toFixed(1)+" KB")})]})]})]}),(0,i.jsxs)("div",{className:"flex flex-col items-end gap-1 flex-shrink-0 ml-2",children:[e.isUploaded&&(0,i.jsx)("span",{className:"bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400 px-2 py-1 rounded text-xs",children:"\u2705 Done"}),e.isUploading&&(0,i.jsxs)("span",{className:"bg-blue-100 dark:bg-blue-500/20 text-blue-700 dark:text-blue-400 px-2 py-1 rounded text-xs flex items-center gap-1",children:[(0,i.jsx)("div",{className:"w-2 h-2 border border-blue-500 border-t-transparent rounded-full animate-spin"}),e.uploadPercentage||0,"%"]})]})]})},t);var r}))})]}),(0,i.jsxs)("div",{className:"flex flex-wrap gap-3 mt-4",children:[(0,i.jsx)("button",{onClick:c,disabled:!l||0===l.length||o||!m,className:"flex-1 px-4 py-2 text-sm font-medium transition-all border rounded group bg-blue-50 dark:bg-blue-500/10 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-500/30 hover:bg-blue-100 dark:hover:bg-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,i.jsx)("div",{className:"relative",children:o?"Uploading...":"Upload Firmware"})}),(0,i.jsx)("button",{onClick:h,disabled:!m,className:"flex-1 px-4 py-2 text-sm font-medium transition-all border rounded group bg-red-50 dark:bg-red-500/10 text-red-700 dark:text-red-400 border-red-200 dark:border-red-500/30 hover:bg-red-100 dark:hover:bg-red-500/20 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,i.jsx)("div",{className:"relative",children:"Erase Files"})}),(0,i.jsx)("button",{onClick:g,disabled:!m,className:"flex-1 px-4 py-2 text-sm font-medium transition-all border rounded group bg-gray-50 dark:bg-white/5 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-white/10 hover:bg-gray-100 dark:hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,i.jsx)("div",{className:"relative",children:"Confirm Files"})})]})]})},o=e=>{let{fileFsInputRef:t,fileSystemUploadStatus:r,fileSystemUploadProgress:a,onFileSystemSelection:n,onFileSystemUploadStart:l,isConnected:o=!1}=e;const[d,c]=(0,s.useState)(!1);return(0,i.jsxs)("div",{className:"space-y-6",children:[(0,i.jsxs)("div",{className:"relative",children:[(0,i.jsx)("input",{type:"file",ref:t,onChange:n,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",accept:".bin"}),(0,i.jsx)("div",{className:`\n            relative border-2 border-dashed rounded-xl p-4 text-center transition-all duration-200\n            ${d?"border-zswatch-secondary bg-zswatch-secondary/5 scale-105":"border-gray-300 dark:border-gray-600 hover:border-zswatch-secondary/50 hover:bg-zswatch-secondary/5"}\n          `,onDragOver:e=>{e.preventDefault(),c(!0)},onDragLeave:e=>{e.preventDefault(),c(!1)},onDrop:e=>{if(e.preventDefault(),c(!1),e.dataTransfer.files.length>0){const t={target:{files:e.dataTransfer.files}};n(t)}},children:(0,i.jsxs)("div",{className:"transition-all duration-200 "+(d?"scale-110":""),children:[(0,i.jsx)("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:d?"Drop your file system file here":"Upload File System"}),(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Drag and drop your .bin file here"})]})})]}),null!==a&&(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,i.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:"Upload Progress"}),(0,i.jsxs)("span",{className:"font-medium text-gray-900 dark:text-white",children:[a,"%"]})]}),(0,i.jsx)("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:(0,i.jsx)("div",{className:"bg-gradient-to-r from-zswatch-secondary to-zswatch-primary h-3 rounded-full transition-all duration-300 relative overflow-hidden",style:{width:`${a}%`},children:(0,i.jsx)("div",{className:"absolute inset-0 bg-white/20 animate-pulse"})})})]}),r&&"Select a filesystem file"!==r&&(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsxs)("h4",{className:"text-sm font-medium text-gray-900 dark:text-white",children:["\ud83d\udccb File System",(0,i.jsxs)("span",{className:"ml-2 text-xs text-gray-600 dark:text-gray-400",children:["- ",r]})]})}),(0,i.jsx)("div",{className:"flex gap-3",children:(0,i.jsx)("button",{onClick:l,disabled:!o||null!==a,className:"flex-1 px-4 py-2 text-sm font-medium transition-all border rounded group bg-blue-50 dark:bg-blue-500/10 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-500/30 hover:bg-blue-100 dark:hover:bg-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed",children:(0,i.jsx)("div",{className:"relative",children:null!==a?"Uploading...":"Upload File System"})})})]})]})};var d=r(1909),c=r.n(d);const h="idle",g="recv_pkt_second",u="recv_frag_second",m="collect_pkt",f="collect_frag",p=1545,x=1044;const b=class{constructor(e){void 0===e&&(e={}),this.SERVICE_UUID="8d53dc1d-1db7-4cd3-868b-8a527460aa84",this.CHARACTERISTIC_UUID="da2e7828-fbce-4e01-ae9e-261174997c48",this._mtu=244,this._netbuf_size=2450,this._device=null,this._service=null,this._characteristic=null,this._connectCallback=null,this._connectingCallback=null,this._disconnectCallback=null,this._messageCallback=null,this._imageUploadProgressCallback=null,this._uploadIsInProgress=!1,this._chunkTimeout=5e3,this._retryCount=0,this._buffer=new Uint8Array,this._logger=e.logger||{info:console.log,error:console.error},this._seq=0,this._userRequestedDisconnect=!1,this._transport=e.transport||"ble",this._bleDisconnectListener=null,this._serialPort=null,this._serialReader=null,this._serialWriter=null,this._serialReadLoopActive=!1,this._serialReadLoopPromise=null,this._serialReadChunkSize=e.serialReadChunkSize||512,this._serialWriteChunkSize=e.serialWriteChunkSize||512,this._serialDisconnectListener=null,this._serialFrameState=h,this._serialCurrentFrame=[],this._serialRxContext={buffer:new Uint8Array,expectedLength:null},this._deviceName=null}setTransport(e){if(!["ble","serial"].includes(e))throw new Error(`Unsupported transport: ${e}`);return this._transport=e,this}_normalizeConnectOptions(e){let t=this._transport||"ble",r=null;return Array.isArray(e)||null===e?r=e:e&&"object"==typeof e&&(t=e.transport||t,r=e.filters??null),{transport:t,filters:r}}async _requestDevice(e){console.log(e);const t={acceptAllDevices:!0,optionalServices:[6159,this.SERVICE_UUID]};return e&&(t.filters=e,t.acceptAllDevices=!1),navigator.bluetooth.requestDevice(t)}async connect(e){void 0===e&&(e=null);const{transport:t,filters:r}=this._normalizeConnectOptions(e);if(this.setTransport(t),"ble"===t)return this._connectBle(r);if("serial"===t)return this._connectSerial();throw new Error(`Unsupported transport: ${t}`)}async _connectBle(e){try{this._bleDisconnectListener&&this._device&&this._device.removeEventListener("gattserverdisconnected",this._bleDisconnectListener),this._device=await this._requestDevice(e),this._deviceName=this._device&&this._device.name?this._device.name:"BLE Device",this._logger.info(`Connecting to device ${this.name||"unknown"} over BLE...`),this._bleDisconnectListener=async e=>{this._logger.info(e),this._userRequestedDisconnect?this._disconnected():(this._logger.info("Trying to reconnect"),this._connectBleWithDelay(1e3))},this._device.addEventListener("gattserverdisconnected",this._bleDisconnectListener),this._connectBleWithDelay(0)}catch(t){this._logger.error(t),await this._disconnected()}}_connectBleWithDelay(e){void 0===e&&(e=1e3),setTimeout((async()=>{try{this._connectingCallback&&this._connectingCallback();const e=await this._device.gatt.connect();this._logger.info("Server connected."),this._service=await e.getPrimaryService(this.SERVICE_UUID),this._logger.info("Service connected."),this._characteristic=await this._service.getCharacteristic(this.CHARACTERISTIC_UUID),this._logger.info("Characteristic connected."),this._characteristic.addEventListener("characteristicvaluechanged",this._notification.bind(this)),this._logger.info("Notifications enabled."),await this._characteristic.startNotifications(),this._logger.info("Notifications started."),this._mtu=e.mtu||this._mtu,this._logger.info(`MTU size: ${this._mtu} bytes`),this._device&&this._device.name&&(this._deviceName=this._device.name),await this._connected(),this._logger.info("Connected."),this._uploadIsInProgress&&this._uploadNext()}catch(e){this._logger.error(e),await this._disconnected()}}),e)}async _connectSerial(){try{if(!navigator.serial)throw new Error("Web Serial is not supported in this browser.");this._logger.info("Requesting serial port..."),this._serialPort=await navigator.serial.requestPort(),this._device=this._serialPort,this._connectingCallback&&this._connectingCallback();const t={baudRate:115200};if(await this._serialPort.open(t),this._serialWriter){try{await this._serialWriter.close()}catch(e){this._logger.error("Serial writer close error:",e)}this._serialWriter=null}return this._serialWriter=this._serialPort.writable?this._serialPort.writable.getWriter():null,this._serialReadLoopActive=!0,this._serialFrameState=h,this._serialCurrentFrame=[],this._serialRxContext={buffer:new Uint8Array,expectedLength:null},this._buffer=new Uint8Array,this._mtu=512,this._deviceName="ZSWatch Serial",this._serialDisconnectListener||(this._serialDisconnectListener=e=>{e.port===this._serialPort&&(this._logger.info("Serial port disconnected."),this._disconnectSerial(!0))},navigator.serial.addEventListener("disconnect",this._serialDisconnectListener)),this._logger.info("Serial port opened."),await this._connected(),this._startSerialReadLoop(),this._uploadIsInProgress&&this._uploadNext(),this._serialPort}catch(t){this._logger.error(t),await this._disconnected()}}_startSerialReadLoop(){if(!this._serialPort||!this._serialPort.readable||!this._serialReadLoopActive)return;this._serialReader=this._serialPort.readable.getReader();this._serialReadLoopPromise=(async()=>{try{for(;this._serialReadLoopActive;){const{value:e,done:t}=await this._serialReader.read();if(t)break;e&&this._handleIncoming(e)}}catch(e){this._serialReadLoopActive&&this._logger.error("Serial read error:",e)}finally{if(this._serialReader){try{this._serialReader.releaseLock()}catch(t){this._logger.error("Failed to release serial reader lock:",t)}this._serialReader=null}}})()}async _disconnectSerial(e){if(void 0===e&&(e=!1),this._serialPort){if(this._serialReadLoopActive=!1,this._serialReader)try{await this._serialReader.cancel()}catch(t){this._logger.error("Error cancelling serial reader:",t)}if(this._serialReadLoopPromise){try{await this._serialReadLoopPromise}catch(t){this._logger.error("Serial read loop error:",t)}this._serialReadLoopPromise=null}if(this._serialWriter){try{await this._serialWriter.close()}catch(t){this._logger.error("Error closing serial writer:",t)}try{this._serialWriter.releaseLock()}catch(r){this._logger.error("Failed to release serial writer lock:",r)}this._serialWriter=null}if(this._serialDisconnectListener){try{navigator.serial.removeEventListener("disconnect",this._serialDisconnectListener)}catch(t){this._logger.error("Failed to remove serial disconnect listener:",t)}this._serialDisconnectListener=null}if("function"==typeof this._serialPort?.setSignals)try{await this._serialPort.setSignals({dataTerminalReady:!1})}catch(t){this._logger.error("Failed to clear serial port signals:",t)}try{await this._serialPort.close()}catch(t){this._logger.error("Error closing serial port:",t)}this._serialPort=null,this._serialFrameState=h,this._serialCurrentFrame=[],this._serialRxContext={buffer:new Uint8Array,expectedLength:null},await this._disconnected()}else e||await this._disconnected()}async disconnect(){return this._userRequestedDisconnect=!0,"serial"===this._transport?this._disconnectSerial():this._device&&this._device.gatt&&this._device.gatt.connected?this._device.gatt.disconnect():void await this._disconnected()}onConnecting(e){return this._connectingCallback=e,this}onConnect(e){return this._connectCallback=e,this}onDisconnect(e){return this._disconnectCallback=e,this}onMessage(e){return this._messageCallback=e,this}onImageUploadProgress(e){return this._imageUploadProgressCallback=e,this}onFsUploadProgress(e){return this._fsUploadProgressCallback=e,this}onImageUploadFinished(e){return this._imageUploadFinishedCallback=e,this}onFsUploadFinished(e){return this._fsUploadFinishedCallback=e,this}async _connected(){this._connectCallback&&this._connectCallback()}async _disconnected(){this._logger.info("Disconnected."),this._disconnectCallback&&this._disconnectCallback(),this._device=null,this._service=null,this._characteristic=null,this._uploadIsInProgress=!1,this._userRequestedDisconnect=!1,this._serialPort=null,this._serialReader=null,this._serialWriter=null,this._serialReadLoopActive=!1,this._serialReadLoopPromise=null,this._serialDisconnectListener=null,this._serialFrameState=h,this._serialCurrentFrame=[],this._serialRxContext={buffer:new Uint8Array,expectedLength:null},this._deviceName=null}get name(){return this._deviceName}isConnected(){return"serial"===this._transport?Boolean(this._serialPort&&this._serialWriter&&this._serialReadLoopActive):Boolean(this._device&&this._device.gatt&&this._device.gatt.connected)}sleep(e){return new Promise((t=>setTimeout(t,e)))}splitBuffer(e,t){void 0===t&&(t=20);const r=[],s=new Uint8Array(e);for(let a=0;a<s.length;a+=t)r.push(s.slice(a,a+t));return r}async writeLargeBuffer(e,t,r,s){void 0===r&&(r=20),void 0===s&&(s=1);const a=this.splitBuffer(e,r);for(const n of a){try{t.writeValueWithoutResponse(n)}catch(i){console.warn("Write failed:",i),await this.sleep(2*s);continue}await this.sleep(s)}}async _writeRaw(e){"serial"===this._transport?await this._writeSerial(e):this.writeLargeBuffer(e,this._characteristic,this._mtu,5)}async _writeSerial(e){if(!this._serialPort||!this._serialWriter)throw new Error("Serial port is not ready to send data.");const t=e instanceof Uint8Array?e:new Uint8Array(e),r=this._crc16(t),s=t.length+2,a=new Uint8Array(2+t.length+2);a[0]=s>>8&255,a[1]=255&s,a.set(t,2),a[a.length-2]=r>>8&255,a[a.length-1]=255&r;const i=3*Math.floor(31);let n=p,l=0;for(;l<a.length;){const e=a.length-l,t=Math.min(i,e),r=a.slice(l,l+t),s=this._buildSerialFrame(n,r);await this._serialWriter.write(s),l+=t,n=x}}_buildSerialFrame(e,t){const r=new Uint8Array([e>>8,255&e]),s=this._base64Encode(t),a=this._asciiToUint8(s),i=new Uint8Array(r.length+a.length+1);return i.set(r,0),i.set(a,r.length),i[i.length-1]=10,i}_base64Encode(e){if(!e||0===e.length)return"";let t="";for(let r=0;r<e.length;r+=1)t+=String.fromCharCode(e[r]);return btoa(t)}_base64Decode(e){if(!e)return new Uint8Array;try{const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e+=1)r[e]=t.charCodeAt(e);return r}catch(t){return this._logger.error("Failed to decode base64 serial frame:",t),null}}_asciiToUint8(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;r+=1)t[r]=e.charCodeAt(r);return t}_uint8ToAscii(e){let t="";for(let r=0;r<e.length;r+=1)t+=String.fromCharCode(e[r]);return t}async _sendMessage(e,t,r,s){let a=[];void 0!==s&&(a=[...new Uint8Array(c().encode(s))]);const i=255&a.length,n=[e,0,a.length>>8,i,t>>8,255&t,this._seq,r,...a];await this._writeRaw(Uint8Array.from(n)),this._seq=(this._seq+1)%256}_notification(e){e&&e.target&&this._handleIncoming(e.target.value)}_handleIncoming(e){e&&("serial"===this._transport?this._handleSerialBytes(e):this._appendToMessageBuffer(e))}_normalizeIncomingData(e){return e?e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)):e instanceof ArrayBuffer||Array.isArray(e)?new Uint8Array(e):null:null}_handleSerialBytes(e){for(const t of e)switch(this._serialFrameState){case h:6===t?(this._serialFrameState=g,this._serialCurrentFrame=[t]):4===t&&(this._serialFrameState=u,this._serialCurrentFrame=[t]);break;case g:9===t?(this._serialCurrentFrame.push(t),this._serialFrameState=m):(this._resetSerialFrameState(),6!==t&&4!==t||(this._serialFrameState=6===t?g:u,this._serialCurrentFrame=[t]));break;case u:20===t?(this._serialCurrentFrame.push(t),this._serialFrameState=f):(this._resetSerialFrameState(),6!==t&&4!==t||(this._serialFrameState=6===t?g:u,this._serialCurrentFrame=[t]));break;case m:case f:if(this._serialCurrentFrame.push(t),this._serialCurrentFrame.length>127){this._logger.error("Serial frame too long, dropping"),this._resetSerialFrameState();break}10===t&&(this._processSerialFrame(new Uint8Array(this._serialCurrentFrame)),this._resetSerialFrameState());break;default:this._resetSerialFrameState()}}_resetSerialFrameState(){this._serialFrameState=h,this._serialCurrentFrame=[]}_processSerialFrame(e){if(!e||e.length<3)return;const t=e[0]<<8|e[1],r=e.slice(2,e.length-1),s=this._uint8ToAscii(r),a=this._base64Decode(s);null!==a?this._handleSerialFragment(t,a):this._resetSerialPacketState()}_handleSerialFragment(e,t){if(!t)return void this._resetSerialPacketState();const r=this._serialRxContext;if(e===p)r.buffer=new Uint8Array,r.expectedLength=null;else{if(e!==x)return this._logger.error(`Unknown serial frame header: 0x${e.toString(16)}`),void this._resetSerialPacketState();if(null==r.expectedLength&&0===r.buffer.length)return this._logger.error("Received serial fragment without initial packet"),void this._resetSerialPacketState()}if(r.buffer=this._concatUint8Arrays(r.buffer,t),e===p){if(r.buffer.length<2)return;r.expectedLength=r.buffer[0]<<8|r.buffer[1],r.buffer=r.buffer.slice(2)}if(null==r.expectedLength)return;if(r.buffer.length<r.expectedLength)return;if(r.buffer.length>r.expectedLength)return this._logger.error("Serial packet buffer longer than expected length; dropping"),void this._resetSerialPacketState();const s=r.buffer,a=this._crc16(s);if(0!==a)return this._logger.error("Serial CRC mismatch (crc="+a+")"),void this._resetSerialPacketState();const i=s.slice(0,s.length-2);this._appendToMessageBuffer(i),this._resetSerialPacketState()}_resetSerialPacketState(){this._serialRxContext={buffer:new Uint8Array,expectedLength:null}}_concatUint8Arrays(e,t){const r=e||new Uint8Array,s=t||new Uint8Array;if(0===r.length)return s.slice();if(0===s.length)return r.slice();const a=new Uint8Array(r.length+s.length);return a.set(r,0),a.set(s,r.length),a}_crc16(e){let t=0;for(let r=0;r<e.length;r+=1){t^=e[r]<<8;for(let e=0;e<8;e+=1)t=32768&t?65535&(t<<1^4129):t<<1&65535}return 65535&t}_appendToMessageBuffer(e){if(e&&0!==e.length)for(this._buffer=new Uint8Array([...this._buffer,...e]);this._buffer.length>=8;){const e=256*this._buffer[2]+this._buffer[3];if(this._buffer.length<e+8)break;const t=this._buffer.slice(0,e+8);this._processMessage(t),this._buffer=this._buffer.slice(e+8)}}_processMessage(e){const[t,r,s,a,i,n,l,o]=e,d=c().decode(e.slice(8).buffer),h=256*s+a,g=256*i+n;if(1===g&&1===o&&(0===d.rc||void 0===d.rc)&&d.off)return this._uploadTimeout&&clearTimeout(this._uploadTimeout),this._uploadOffset=d.off,this._uploadIsInProgress&&this._uploadNext(),void(this._retryCount=0);if(8===g&&0===o){if((0===d.rc||void 0===d.rc)&&d.off)return this._uploadTimeout&&(clearTimeout(this._uploadTimeout),console.log("Upload timeout cleared")),this._uploadOffset=d.off,this._uploadIsInProgress&&this._uploadNextFileSystem(),void(this._retryCount=0);0!==d.rc&&(this._logger.error("Error uploading file:",d.rc),this._uploadTimeout&&(clearTimeout(this._uploadTimeout),console.log("Upload timeout cleared")),this._retryCount<3?(this._logger.info("Retrying upload..."),this._retryCount++,this._uploadNextFileSystem()):(this._logger.error("Upload failed after 3 retries"),this._uploadIsInProgress&&(this._fsUploadFinishedCallback(!1),this._uploadIsInProgress=!1)))}this._messageCallback&&this._messageCallback({op:t,group:g,id:o,data:d,length:h})}cmdReset(){return this._sendMessage(2,0,5)}smpEcho(e){return this._sendMessage(2,0,0,{d:e})}cmdImageState(){return this._sendMessage(0,1,0)}cmdImageErase(e){return void 0===e&&(e=1),this._sendMessage(2,1,5)}cmdImageTest(e){return this._sendMessage(2,1,0,{hash:e,confirm:!1})}cmdImageConfirm(e){return this._sendMessage(2,1,0,{hash:e,confirm:!0})}_hash(e){return crypto.subtle.digest("SHA-256",e)}async _uploadNext(){if(this._uploadOffset>=this._uploadImage.byteLength||!this._uploadIsInProgress)return this._uploadIsInProgress=!1,void this._imageUploadFinishedCallback();this._uploadTimeout&&clearTimeout(this._uploadTimeout),this._uploadTimeout=setTimeout((()=>{this._logger.info("Upload chunk timeout, retry"),this._uploadNext()}),this._chunkTimeout);const e={data:new Uint8Array,off:this._uploadOffset,image:this._uploadImageNumber};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength,e.sha=new Uint8Array(await this._hash(this._uploadImage))),this._imageUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});const t=this._mtu-c().encode(e).byteLength-8;e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t));try{await this._sendMessage(2,1,1,e)}catch(r){return this._logger.error("Error sending upload message:",r),void clearTimeout(this._uploadTimeout)}}async cmdUpload(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0),this._uploadIsInProgress?this._logger.error("Upload is already in progress."):(this._logger.info(`Starting upload of image ${t}...`),this._uploadIsInProgress=!0,this._logger.info(`Image size: ${e.byteLength} bytes`),this._logger.info(`MTU size: ${this._mtu} bytes`),this._uploadOffset=0,this._retryCount=0,this._uploadImage=e,this._uploadImageNumber=t,this._uploadSlot=r,this._uploadNext())}async imageInfo(e){const t={},r=new Uint8Array(e);if(r.length<32)throw new Error("Invalid image (too short file)");if(61!==r[0]||184!==r[1]||243!==r[2]||150!==r[3])throw new Error("Invalid image (wrong magic bytes)");if(0!==r[4]||0!==r[5]||0!==r[6]||0!==r[7])throw new Error("Invalid image (wrong load address)");const s=r[8]+256*r[9];if(0!==r[10]||0!==r[11])throw new Error("Invalid image (wrong protected TLV area size)");const a=r[12]+256*r[13]+65536*r[14]+r[15]*2**24;if(t.imageSize=a,r.length<a+s)throw new Error("Invalid image (wrong image size)");if(0!==r[16]||0!==r[17]||0!==r[18]||0!==r[19])throw new Error("Invalid image (wrong flags)");const i=`${r[20]}.${r[21]}.${r[22]+256*r[23]}`;return t.version=i,t.hash=[...new Uint8Array(await this._hash(e.slice(0,a+s)))].map((e=>e.toString(16).padStart(2,"0"))).join(""),t}async cmdUploadFileSystemImage(e,t){this._uploadIsInProgress?this._logger.error("Upload is already in progress."):(this._logger.info(`Starting upload of image to ${t}... of ${e.byteLength} bytes`),this._uploadIsInProgress=!0,this._logger.info(`Image size: ${e.byteLength} bytes`),this._logger.info(`MTU size: ${this._mtu} bytes`),this._uploadOffset=0,this._retryCount=0,this._uploadImage=e,this._uploadName=t,this._uploadNextFileSystem())}async _uploadNextFileSystem(){if(this._uploadOffset>=this._uploadImage.byteLength||!this._uploadIsInProgress)return this._uploadIsInProgress=!1,console.log("Upload finished"),void this._fsUploadFinishedCallback(!0);this._uploadTimeout&&clearTimeout(this._uploadTimeout),this._uploadTimeout=setTimeout((()=>{this._logger.info("Upload chunk timeout, retry"),this._uploadNextFileSystem()}),this._chunkTimeout);const e={data:new Uint8Array,off:this._uploadOffset,name:this._uploadName};0===this._uploadOffset&&(e.len=this._uploadImage.byteLength),this._fsUploadProgressCallback({percentage:Math.floor(this._uploadOffset/this._uploadImage.byteLength*100)});let t=this._netbuf_size-c().encode(e).byteLength-20;t-=t%4,console.log("File offset",this._uploadOffset),e.data=new Uint8Array(this._uploadImage.slice(this._uploadOffset,this._uploadOffset+t));try{this._sendMessage(2,8,0,e)}catch(r){return this._logger.error("Error sending upload message:",r),void clearTimeout(this._uploadTimeout)}}};var y=r(797);const _={"app.internal.bin":0,"ipc_radio.bin":1,"app.external.bin":2},w="initial",v="connecting",k="connected",N="connected_advanced";var j=r(1710),S=r.n(j);const U=e=>{const[t,r]=(0,s.useState)(null),[a,i]=(0,s.useState)(null),[n,l]=(0,s.useState)(!1),[o,d]=(0,s.useState)([]),[c,h]=(0,s.useState)("Select image files (.bin or .zip)"),g=(0,s.useRef)(null),u=(0,s.useRef)(null),m=(0,s.useRef)(null),f=(0,s.useRef)(null),p=(0,s.useRef)(0),x=async t=>{if(y())if(t){l(!0),r(0),i(null),h("Uploading..."),f.current=t.fileSize,u.current=Date.now(),m.current=Date.now(),p.current=0;try{await e.cmdUpload(t.fileData,t.imageNumber),l(!1),d((e=>e.map((e=>e===t?{...e,isUploading:!0}:e))))}catch(s){h("Upload failed"),l(!1)}}else h("Ready to upload");else h("Connect to a device before uploading")},b=async()=>{if(!y())return void alert("Connect to a device before confirming images.");if(window.confirm("Do you want to confirm the images and restart the device? After confirming, you need to restart the device to apply the changes."))for(const t of o){const r=Uint8Array.from(t.hash.match(/.{1,2}/g).map((e=>parseInt(e,16))));await e.cmdImageTest(r)}},y=()=>e?.isConnected?.()??!1;return{fileUploadPercentage:t,fileUploadSpeed:a,isFileUploadInProgress:n,fileInfos:o,fileStatus:c,setFileStatus:h,fileInputRef:g,handleFileChange:t=>{const r=t.target.files[0];if(!r)return void h("No file selected");h(`Processing ${r.name}...`);const s=new FileReader;s.onload=async()=>{"application/zip"===r.type?await(async(t,r)=>{const s=new(S());try{const t=await s.loadAsync(r.result),a=await Promise.all(Object.keys(t.files).filter((e=>e.endsWith(".bin"))).map((async r=>{const s=await t.files[r].async("arraybuffer"),a=_[r];if(null==a)return alert(`Invalid file: ${r}. Please use a valid binary file name.`),null;const i=await e.imageInfo(s);return{version:i.version,hash:i.hash,fileSize:s.byteLength,imageNumber:a,fileData:s,name:r,isUploaded:!1,isUploading:!1,isSetPending:!1,mcuMgrImageStatus:""}})));d((e=>[...e.filter((e=>!a.some((t=>t&&t.imageNumber===e.imageNumber)))),...a.filter((e=>null!==e))])),h("Zip file processed - Ready to upload")}catch(a){console.error("Error reading zip file:",a),h("Invalid zip file")}})(0,s):await(async(t,r)=>{let s=_[t.name];if(null==s&&(s=parseInt(prompt("Enter the image number:","0"),10),isNaN(s)||s<0))return alert("Invalid image number. Please enter a non-negative integer."),void h("Ready to upload");try{const a=await e.imageInfo(r.result);d((e=>[...e.filter((e=>e.imageNumber!==s)),{version:a.version,hash:a.hash,fileSize:r.result.byteLength,imageNumber:s,fileData:r.result,name:t.name,isUploaded:!1,isUploading:!1,isSetPending:!1,mcuMgrImageStatus:""}])),h("Binary file processed - Ready to upload")}catch(a){console.error("Error reading file:",a),h("Invalid image file")}})(r,s),y()&&e.cmdImageState()},s.readAsArrayBuffer(r)},handleFileUpload:async()=>{if(o.length<=0)l(!1);else if(o[0].fileData){if(!y())return void h("Connect to a device before uploading");const e=o.find((e=>!e.isUploaded));e?x(e):(h("All files uploaded"),l(!1),b())}},clearFiles:()=>{d([]),h("Select image files (.bin or .zip)"),g.current&&(g.current.value="")},setupUploadListeners:()=>{e&&(e.onImageUploadProgress((e=>{let{percentage:t}=e;h(`Uploading... ${t}%`),r(t);const s=Date.now(),a=(s-m.current)/1e3,n=t-p.current;if(n>0&&f.current){const e=n/100*f.current;i((e/1024/a).toFixed(2)),m.current=s,p.current=t}})),e.onImageUploadFinished((()=>{h("Upload complete"),i(null),console.log("File upload finished",o);const t=o.find((e=>!e.isUploaded&&!e.isUploading));t?x(t):(console.log("All files uploaded"),y()&&e.cmdImageState(),b()),d((e=>e.map((e=>e.isUploading?{...e,isUploaded:!0,isUploading:!1}:e))))})))},setFileInfos:d}},C=e=>{const[t,r]=(0,s.useState)([]),[a,i]=(0,s.useState)(!1);return{firmwares:t,isFetchingFirmwares:a,fetchAndSetFirmwares:async t=>{i(!0);const s=await async function(e,t){void 0===t&&(t=5);let r=[];try{const{owner:s,repo:a,token:i}=e,n=await fetch(`https://api.github.com/repos/${s}/${a}/actions/runs`,i?{headers:{Authorization:`Bearer ${i}`}}:{}),l=await n.json();if(!l.workflow_runs||0===l.workflow_runs.length)return console.log("No workflow runs found."),[];console.log("Found",l,l.workflow_runs.length,"workflow runs.");const o=l.workflow_runs.filter((e=>"success"===e.conclusion&&"gh-pages"!==e.head_branch)).slice(0,t);console.log(`Fetching artifacts from the latest ${t} workflow runs...`);for(const e of o){console.log(`Processing workflow run: ${e.id} (${e.name})`,e);const t=await fetch(`https://api.github.com/repos/${s}/${a}/actions/runs/${e.id}/artifacts`,i?{headers:{Authorization:`Bearer ${i}`}}:{}),n=await t.json();if(!n.artifacts||0===n.artifacts.length){console.log(`No artifacts found for workflow run: ${e.id}`);continue}const l={branch:e.head_branch,user:e.actor.login,runId:e.id,artifacts:n.artifacts.filter((e=>e.name.includes("watchdk@1")||e.name.includes("@4")||e.name.includes("@5")))};r.push(l)}}catch(s){console.error("Error fetching artifacts:",s)}return r}(e,t);console.log("Fetched firmwares:",s),s&&r(s),i(!1)},downloadAndFlashFirmware:async(t,r,s)=>{try{s("Downloading firmware..."),s("Firmware download started. Please check your browser's downloads."),((e,t,r)=>{const s=`https://github.com/${e.owner}/${e.repo}/actions/runs/${t}/artifacts/${r}`;console.log("Download URL:",s),window.location.href=s})(e,t,r)}catch(a){console.error("Error downloading or flashing firmware:",a),s("Failed to download firmware.")}}}},F=()=>{const e=(()=>{const{siteConfig:e}=(0,y.A)();return{owner:"ZSWatch",repo:"ZSWatch",token:e.customFields.githubToken||""}})(),{mcumgr:t,deviceName:r,screen:d,images:c,bluetoothAvailable:h,serialAvailable:g,transport:u,setScreen:m,handleTransportChange:f,handleDeviceNameChange:p,handleConnect:x,handleDisconnect:_}=(()=>{const[e,t]=(0,s.useState)("ZSWatch"),[r,a]=(0,s.useState)(w),[i,n]=(0,s.useState)([]),[l,o]=(0,s.useState)(!1),[d,c]=(0,s.useState)(!!navigator.serial),[h,g]=(0,s.useState)("ble"),u=(0,s.useRef)(new b({transport:"ble"})).current;return(0,s.useEffect)((()=>{(async()=>{try{const e=await(navigator.bluetooth?.getAvailability());o(!!e)}catch{o(!1)}})()}),[]),(0,s.useEffect)((()=>{u.onConnecting((()=>{a(v)})),u.onConnect((()=>{t((e=>u.name||e)),a(k),u.cmdImageState()})),u.onDisconnect((()=>{a(w)})),u.onMessage((e=>{let{group:t,id:r,data:s}=e;switch(t){case 0:switch(r){case 0:s?.rc&&0!==s.rc?alert(`Echo failed: Error code ${s.rc}`):alert(s?.r??"");break;case 2:console.table(s.tasks);break;case 3:console.log(s)}break;case 1:0===r&&n(s.images||[]);break;default:console.log("Unknown group")}}))}),[u]),(0,s.useEffect)((()=>{u.setTransport(h)}),[h,u]),{mcumgr:u,deviceName:e,screen:r,images:i,bluetoothAvailable:l,serialAvailable:d,transport:h,setScreen:a,handleTransportChange:e=>{"ble"!==e&&"serial"!==e||(g(e),u.setTransport(e))},handleDeviceNameChange:e=>{t(e)},handleConnect:async()=>{if("serial"===h)return void await u.connect({transport:"serial"});const t=e?[{namePrefix:e}]:null;await u.connect({transport:"ble",filters:t})},handleDisconnect:async()=>{await u.disconnect()}}})(),j=d===k||d===N,{fileUploadPercentage:S,fileUploadSpeed:F,isFileUploadInProgress:I,fileInfos:A,fileStatus:P,setFileStatus:L,fileInputRef:R,handleFileChange:D,handleFileUpload:z,clearFiles:E,setupUploadListeners:T,setFileInfos:B}=U(t),{fileSystemUploadProgress:$,fileSystemUploadStatus:W,fileFsInputRef:O,selectedFile:M,handleFileSystemSelection:q,startFileSystemUpload:V,setupFileSystemListeners:Z}=(e=>{const[t,r]=(0,s.useState)(null),[a,i]=(0,s.useState)("Select a filesystem file"),[n,l]=(0,s.useState)(null),o=(0,s.useRef)(null);return{fileSystemUploadProgress:t,fileSystemUploadStatus:a,fileFsInputRef:o,selectedFile:n,handleFileSystemSelection:e=>{const t=e.target.files[0];if(!t)return i("No file selected"),void l(null);console.log("Selected file:",t),l(t),i(`File selected: ${t.name} - Ready to upload`)},startFileSystemUpload:async()=>{if(!n)return void i("No file selected");const t=new FileReader;t.onload=async s=>{i("Uploading..."),r(0);try{await e.cmdUploadFileSystemImage(t.result,"/S/full_fs"),i("Upload started")}catch(a){console.error("Filesystem upload failed:",a),i("Upload failed"),r(null)}o.current.value=null,l(null)},t.readAsArrayBuffer(n)},setupFileSystemListeners:()=>{e&&(e.onFsUploadProgress((e=>{let{percentage:t}=e;r(t)})),e.onFsUploadFinished((e=>{i(e?"Upload complete":"Upload failed"),r(null)})))}}})(t),{firmwares:H,isFetchingFirmwares:K,fetchAndSetFirmwares:Y,downloadAndFlashFirmware:G}=C(e);(0,s.useEffect)((()=>{t&&(T(),Z())}),[T,Z,t]);const Q=(e,t)=>{G(e,t,L)},J=()=>{const e=prompt("Enter a text message to send","Hello World!");e&&t&&t.smpEcho(e)},X=()=>{t&&t.cmdReset()},ee=()=>{const e=d===v,s="ble"===u?h:g,a="ble"===u?"BLE":"USB Serial";return(0,i.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-8 xl:grid-cols-11 gap-6",children:[(0,i.jsxs)("div",{className:"lg:col-span-2 xl:col-span-3 space-y-6",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Connection"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsxs)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:[(0,i.jsx)("div",{className:"flex items-center justify-between mb-4",children:(0,i.jsx)("div",{className:"px-2 py-1 rounded-full text-xs font-medium "+(j?"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300":e?"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 animate-pulse":"bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300"),children:j?`Connected (${a})`:e?"Connecting...":"Disconnected"})}),(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Connection method"}),(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsx)("button",{type:"button",disabled:j||e,onClick:()=>f("ble"),className:"flex-1 px-3 py-2 text-sm rounded-lg border transition-all disabled:opacity-50 disabled:cursor-not-allowed "+("ble"===u?"bg-zswatch-primary text-black border-zswatch-primary":"bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-white/10 hover:bg-gray-200 dark:hover:bg-white/20"),children:"Bluetooth (BLE)"}),(0,i.jsx)("button",{type:"button",disabled:j||e,onClick:()=>f("serial"),className:"flex-1 px-3 py-2 text-sm rounded-lg border transition-all disabled:opacity-50 disabled:cursor-not-allowed "+("serial"===u?"bg-zswatch-primary text-black border-zswatch-primary":"bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-white/10 hover:bg-gray-200 dark:hover:bg-white/20"),children:"USB Serial (WebSerial)"})]}),(0,i.jsxs)("div",{className:"mt-2 flex flex-wrap gap-3 text-xs text-gray-500 dark:text-gray-400",children:[(0,i.jsxs)("span",{className:h?"text-green-600 dark:text-green-300":"text-red-500 dark:text-red-400",children:["BLE: ",h?"Available":"Unavailable"]}),(0,i.jsxs)("span",{className:g?"text-green-600 dark:text-green-300":"text-red-500 dark:text-red-400",children:["USB Serial: ",g?"Available":"Unavailable"]})]})]}),(0,i.jsxs)("div",{className:"p-3 rounded-lg border "+(s?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800":"bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800"),children:[(0,i.jsxs)("div",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"mr-2",children:s?"\u2705":"\u274c"}),(0,i.jsxs)("span",{className:"text-sm font-medium "+(s?"text-green-800 dark:text-green-300":"text-red-800 dark:text-red-300"),children:["ble"===u?"Bluetooth (BLE)":"USB Serial (WebSerial)"," ",s?"Available":"Unavailable"]})]}),(0,i.jsx)("p",{className:"mt-2 text-xs leading-relaxed "+(s?"text-green-700 dark:text-green-200":"text-red-700 dark:text-red-300"),children:"ble"===u?"Requires a browser with Web Bluetooth support (Chrome, Edge, Opera). Ensure the watch is advertising and not already connected to another device.":"Requires Web Serial support (Chrome or Edge) and watch is in MCUBoot. Enter MCUBoot by holding down top right button while resetting the watch. Or holding down two right buttons for 25 seconds."})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Device name"}),(0,i.jsx)("input",{type:"text",value:r,onChange:e=>p(e.target.value),disabled:"ble"!==u||j||!h,className:"w-full bg-white dark:bg-black/30 border border-gray-300 dark:border-white/20 rounded-lg px-3 py-2 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-zswatch-primary focus:outline-none focus:ring-2 focus:ring-zswatch-primary/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-sm",placeholder:"ZSWatch"}),(0,i.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"ble"===u?"Optional prefix filter. Leave empty to scan for any compatible device.":"Not required when connecting over USB."})]}),(0,i.jsxs)("div",{className:"flex flex-col gap-2",children:[j?(0,i.jsxs)("button",{onClick:_,className:"flex items-center justify-center gap-2 px-4 py-2 bg-red-100 dark:bg-red-500/20 text-red-700 dark:text-red-400 rounded-lg border border-red-300 dark:border-red-500/30 hover:bg-red-200 dark:hover:bg-red-500/30 transition-all",children:[(0,i.jsx)("span",{className:"text-sm",children:"\ud83d\udd0c"}),"Disconnect"]}):(0,i.jsx)("button",{onClick:x,disabled:!s||e,className:"px-4 py-2 bg-zswatch-primary text-black rounded-lg font-medium hover:bg-zswatch-primary/90 transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:e?"Connecting...":"ble"===u?"Connect via BLE":"Connect via Serial"}),j&&(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsxs)("button",{onClick:J,className:"flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white rounded-lg border border-gray-300 dark:border-white/20 hover:bg-gray-200 dark:hover:bg-white/20 transition-all text-sm",children:[(0,i.jsx)("span",{className:"text-xs",children:"\ud83d\udce2"}),"Echo"]}),(0,i.jsxs)("button",{onClick:X,className:"flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white rounded-lg border border-gray-300 dark:border-white/20 hover:bg-gray-200 dark:hover:bg-white/20 transition-all text-sm",children:[(0,i.jsx)("span",{className:"text-xs",children:"\ud83d\udd04"}),"Reset"]})]})]})]})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Browser Support"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:(0,i.jsxs)("ul",{className:"space-y-2 text-sm text-gray-600 dark:text-gray-300",style:{paddingLeft:0,paddingInlineStart:0,margin:0},children:[(0,i.jsxs)("li",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-3"}),"Chrome, Edge, Opera (Desktop)"]}),(0,i.jsxs)("li",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-3"}),"Chrome, Edge (WebSerial / USB serial updates)"]}),(0,i.jsxs)("li",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-3"}),"Chrome (Android)"]}),(0,i.jsxs)("li",{className:"flex items-center",children:[(0,i.jsx)("span",{className:"w-2 h-2 bg-yellow-500 rounded-full mr-3"}),"Bluefy (iOS/iPadOS)"]})]})})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Troubleshooting"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:(0,i.jsxs)("div",{className:"space-y-3",children:[(0,i.jsxs)("details",{className:"group",children:[(0,i.jsxs)("summary",{className:"flex items-center justify-between cursor-pointer text-gray-900 dark:text-white hover:text-zswatch-primary transition-colors text-sm",children:[(0,i.jsx)("span",{children:"Connection issues"}),(0,i.jsx)("span",{className:"group-open:rotate-180 transition-transform",children:"\u25bc"})]}),(0,i.jsxs)("div",{className:"mt-3 space-y-2 text-xs text-gray-600 dark:text-gray-300 pl-4 border-l-2 border-zswatch-primary/30",children:[(0,i.jsx)("p",{className:"m-0",children:"\u2022 Forget device in OS Bluetooth settings"}),(0,i.jsx)("p",{className:"m-0",children:"\u2022 Ensure watch is on"}),(0,i.jsx)("p",{className:"m-0",children:"\u2022 Use supported browser"})]})]}),(0,i.jsxs)("details",{className:"group",children:[(0,i.jsxs)("summary",{className:"flex items-center justify-between cursor-pointer text-gray-900 dark:text-white hover:text-zswatch-primary transition-colors text-sm",children:[(0,i.jsx)("span",{children:"Upload fails"}),(0,i.jsx)("span",{className:"group-open:rotate-180 transition-transform",children:"\u25bc"})]}),(0,i.jsxs)("div",{className:"mt-3 space-y-2 text-xs text-gray-600 dark:text-gray-300 pl-4 border-l-2 border-zswatch-primary/30",children:[(0,i.jsx)("p",{className:"m-0",children:"\u2022 Reset watch, reload page and reconnect"}),(0,i.jsx)("p",{className:"m-0",children:"\u2022 Check file format (.zip or .bin)"}),(0,i.jsx)("p",{className:"m-0",children:"\u2022 Try switching to USB serial mode."})]})]})]})})]})]}),(0,i.jsxs)("div",{className:"lg:col-span-3 xl:col-span-4 space-y-6",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Manual Upload"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-4 shadow-sm",children:(0,i.jsx)(l,{fileInputRef:R,fileStatus:P,fileUploadPercentage:S,fileUploadSpeed:F,fileInfos:A,isFileUploadInProgress:I,onFileChange:D,onFileUpload:z,onEraseFiles:()=>t&&t.cmdImageErase(),onConfirmFiles:()=>t&&t.cmdImageConfirm(),onClearFiles:E,isConnected:j})})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"File System"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-4 shadow-sm",children:(0,i.jsx)(o,{fileFsInputRef:O,fileSystemUploadStatus:W,fileSystemUploadProgress:$,onFileSystemSelection:q,onFileSystemUploadStart:V,isConnected:j})})]})]}),(0,i.jsxs)("div",{className:"lg:col-span-3 xl:col-span-4 space-y-6",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Prebuilt Firmware"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-4"}),(0,i.jsxs)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:[(0,i.jsx)("div",{className:"flex items-center justify-between mb-4",children:(0,i.jsxs)("button",{onClick:()=>Y(6),disabled:K,className:"bg-zswatch-secondary/20 text-zswatch-secondary border border-zswatch-secondary/30 px-3 py-1 rounded text-sm hover:bg-zswatch-secondary/30 transition-all flex items-center gap-1",children:[(0,i.jsx)("span",{className:"text-xs",children:"\ud83d\udd04"}),K?"Fetching...":"Fetch Latest"]})}),(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-300 text-sm mb-4",children:"Download the latest firmware from GitHub Actions."}),(0,i.jsx)(n,{firmwares:H,isFetchingFirmwares:K,onFetchFirmwares:Y,onDownloadFirmware:Q,isConnected:j})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-1",children:"Images"}),(0,i.jsx)("div",{className:"border-b border-gray-200 dark:border-white/20 mb-2"}),(0,i.jsx)("div",{className:"bg-white dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 shadow-sm",children:j?c&&c.length>0?(0,i.jsxs)("div",{className:"space-y-0",children:[c.map(((e,t)=>(0,i.jsx)("div",{className:"border rounded p-2 "+(e.active?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-500/30":"border-gray-200 dark:border-white/10"),children:(0,i.jsxs)("div",{className:"flex items-start justify-between",children:[(0,i.jsxs)("div",{className:"flex-1",children:[(0,i.jsxs)("h4",{className:"font-medium text-gray-900 dark:text-white text-sm m-0 mb-1",children:["Image #",e.image," - Slot ",e.slot]}),(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-0 text-xs text-gray-500 dark:text-gray-400",children:[(0,i.jsxs)("div",{children:["Version: ",e.version||"Unknown"]}),(0,i.jsx)("div",{children:e.bootable?"Bootable":"Not Bootable"}),(0,i.jsxs)("div",{children:["Confirmed: ",e.confirmed?"Yes":"No"]}),(0,i.jsxs)("div",{children:["Pending: ",e.pending?"Yes":"No"]})]}),e.hash&&(0,i.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 font-mono mt-1",children:["Hash: ",Array.from(e.hash).map((e=>e.toString(16).padStart(2,"0"))).join("").substring(0,16),"..."]})]}),(0,i.jsxs)("div",{className:"flex flex-wrap gap-1 ml-2",children:[e.active&&(0,i.jsx)("span",{className:"text-xs bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400 px-2 py-0.5 rounded",children:"\u2705 Active"}),e.pending&&(0,i.jsx)("span",{className:"text-xs bg-yellow-100 dark:bg-yellow-500/20 text-yellow-700 dark:text-yellow-400 px-2 py-0.5 rounded",children:"\u23f3 Pending"}),e.confirmed&&(0,i.jsx)("span",{className:"text-xs bg-blue-100 dark:bg-blue-500/20 text-blue-700 dark:text-blue-400 px-2 py-0.5 rounded",children:"\u2713 Confirmed"}),e.permanent&&(0,i.jsx)("span",{className:"text-xs bg-purple-100 dark:bg-purple-500/20 text-purple-700 dark:text-purple-400 px-2 py-0.5 rounded",children:"\ud83d\udccc Permanent"})]})]})},t))),(0,i.jsxs)("div",{className:"flex gap-2 pt-3 border-t border-gray-200 dark:border-white/10",children:[(0,i.jsx)("button",{onClick:()=>t&&t.cmdImageState(),className:"flex-1 bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white px-3 py-2 rounded text-sm hover:bg-gray-200 dark:hover:bg-white/20 transition-all",children:"Refresh"}),(0,i.jsx)("button",{onClick:()=>t&&t.cmdImageTest(),className:"flex-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-2 rounded text-sm hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-all",children:"Test"}),(0,i.jsx)("button",{onClick:()=>t&&t.cmdImageConfirm(),className:"flex-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-2 rounded text-sm hover:bg-green-200 dark:hover:bg-green-900/50 transition-all",children:"Confirm"}),(0,i.jsx)("button",{onClick:()=>t&&t.cmdImageErase(),className:"flex-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 px-3 py-2 rounded text-sm hover:bg-red-200 dark:hover:bg-red-900/50 transition-all",children:"Erase"})]}),(0,i.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2 flex items-center",children:[(0,i.jsx)("span",{className:"mr-1",children:"\ud83d\udd17"}),"Bluetooth connection required"]})]}):(0,i.jsxs)("div",{className:"text-center py-6",children:[(0,i.jsx)("div",{className:"text-gray-400 text-2xl mb-2",children:"\ud83d\udcf1"}),(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-300 text-sm",children:"No images found on device"})]}):(0,i.jsxs)("div",{className:"text-center py-6",children:[(0,i.jsx)("div",{className:"text-amber-500 text-2xl mb-2",children:"\u26a0\ufe0f"}),(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-300 text-sm",children:"Connect to device to view image status"})]})})]})]})]})};return(0,i.jsx)(a.A,{children:(0,i.jsx)("div",{className:"min-h-screen zswatch-background-gradient",children:(0,i.jsxs)("div",{className:"container mx-auto px-2 py-8",children:[(0,i.jsxs)("div",{className:"text-center mb-8",children:[(0,i.jsx)("h1",{className:"text-4xl font-bold mb-2 text-gray-900 dark:text-gray-100",children:"ZSWatch Firmware Update"}),(0,i.jsx)("p",{className:"text-lg text-gray-600 dark:text-gray-300",children:"Update your ZSWatch firmware wirelessly over Bluetooth Low Energy"})]}),(0,i.jsx)("div",{className:"px-2 pb-8 max-w-7xl mx-auto",children:ee()})]})})})}}}]);
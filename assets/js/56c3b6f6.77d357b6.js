"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[4196],{1595:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"development/writing_apps","title":"Writing Apps","description":"Overview","source":"@site/docs/development/writing_apps.md","sourceDirName":"development","slug":"/development/writing_apps","permalink":"/docs/development/writing_apps","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Image Resources","permalink":"/docs/development/image_resources"},"next":{"title":"Architecture Overview","permalink":"/docs/development/architecture"}}');var t=i(4848),r=i(8453);const c={sidebar_position:5},a="Writing Apps",d={},l=[{value:"Overview",id:"overview",level:2},{value:"App Lifecycle",id:"app-lifecycle",level:2},{value:"Callback Flow",id:"callback-flow",level:3},{value:"Creating a New App Step by Step",id:"creating-a-new-app-step-by-step",level:2},{value:"1. Create the App Directory",id:"1-create-the-app-directory",level:3},{value:"2. Create the Main Source File",id:"2-create-the-main-source-file",level:3},{value:"3. Add a Kconfig Entry (optional)",id:"3-add-a-kconfig-entry-optional",level:3},{value:"4. Create CMakeLists.txt",id:"4-create-cmakeliststxt",level:3},{value:"5. Provide an Icon",id:"5-provide-an-icon",level:3},{value:"The <code>application_t</code> Struct",id:"the-application_t-struct",level:2},{value:"App Categories",id:"app-categories",level:2},{value:"Subscribing to Events (Zbus)",id:"subscribing-to-events-zbus",level:2},{value:"Example: Listening for BLE Data",id:"example-listening-for-ble-data",level:3},{value:"Periodic Events",id:"periodic-events",level:2},{value:"UI Pattern",id:"ui-pattern",level:2},{value:"Recommended: Separate Logic and UI",id:"recommended-separate-logic-and-ui",level:3},{value:"Advanced: LVGL Editor (XML-Based UI)",id:"advanced-lvgl-editor-xml-based-ui",level:3},{value:"Common Pitfalls",id:"common-pitfalls",level:2},{value:"1. Always Check App State Before Updating UI",id:"1-always-check-app-state-before-updating-ui",level:3},{value:"2. Clean Up Everything in <code>stop_func</code>",id:"2-clean-up-everything-in-stop_func",level:3},{value:"3. Context-Switch From Zbus Callbacks",id:"3-context-switch-from-zbus-callbacks",level:3},{value:"4. Round Display",id:"4-round-display",level:3},{value:"5. Memory Constraints",id:"5-memory-constraints",level:3}];function o(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"writing-apps",children:"Writing Apps"})}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(n.p,{children:["ZSWatch uses a ",(0,t.jsx)(n.strong,{children:"self-registering application framework"}),". There is no central list of apps to edit. Each app registers itself at boot time using Zephyr's ",(0,t.jsx)(n.code,{children:"SYS_INIT"})," mechanism. When you add a new app directory with the right boilerplate, it is automatically discovered and appears in the app picker on the watch."]}),"\n",(0,t.jsxs)(n.p,{children:["All apps live under ",(0,t.jsx)(n.code,{children:"app/src/applications/<app_name>/"}),". The easiest way to create a new app is to ",(0,t.jsx)(n.strong,{children:"copy an existing one"})," (look through the existing apps and copy the most similar one) and modify it."]}),"\n",(0,t.jsxs)(n.p,{children:["For app and UI work, it is recommended to start with the ",(0,t.jsx)(n.a,{href:"/docs/development/linux_development",children:"native simulator"})," for fast iteration. If your app depends on data that is only available on real hardware (sensors, etc.), you can mock or fake that data in the simulator and then validate on hardware later."]}),"\n",(0,t.jsxs)(n.p,{children:["For the full system architecture including managers, events, and BLE communication, see the ",(0,t.jsx)(n.a,{href:"/docs/development/architecture",children:"Architecture Overview"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"app-lifecycle",children:"App Lifecycle"}),"\n",(0,t.jsx)(n.p,{children:"Every app follows a simple state machine:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"STOPPED \u2192 UI_VISIBLE \u2194 UI_HIDDEN \u2192 STOPPED\n"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"State"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_STATE_STOPPED"})}),(0,t.jsx)(n.td,{children:"App is not running. No UI exists."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_STATE_UI_VISIBLE"})}),(0,t.jsx)(n.td,{children:"App UI is on screen. Safe to update LVGL objects."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_STATE_UI_HIDDEN"})}),(0,t.jsxs)(n.td,{children:["App is still running but the screen is off. ",(0,t.jsx)(n.strong,{children:"Do not"})," touch UI objects."]})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"callback-flow",children:"Callback Flow"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"User opens app"})," \u2192 ",(0,t.jsx)(n.code,{children:"start_func(root, group)"})," is called. Create your UI under ",(0,t.jsx)(n.code,{children:"root"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Screen turns off"})," (idle timeout) \u2192 ",(0,t.jsx)(n.code,{children:"ui_unavailable_func()"})," fires. Stop timers, pause UI updates."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Screen turns back on"})," \u2192 ",(0,t.jsx)(n.code,{children:"ui_available_func()"})," fires. Resume UI updates."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"User presses back"})," \u2192 ",(0,t.jsx)(n.code,{children:"back_func()"})," is called. Return ",(0,t.jsx)(n.code,{children:"true"})," to consume the event (stay in app), or ",(0,t.jsx)(n.code,{children:"false"})," to exit."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"App exits"})," \u2192 ",(0,t.jsx)(n.code,{children:"stop_func()"})," is called. You ",(0,t.jsx)(n.strong,{children:"must"})," clean up all LVGL objects, timers, and event subscriptions."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"creating-a-new-app-step-by-step",children:"Creating a New App Step by Step"}),"\n",(0,t.jsx)(n.p,{children:"The recommended approach is to look through the existing apps and copy the most similar one and rename everything. Here is a walkthrough."}),"\n",(0,t.jsx)(n.h3,{id:"1-create-the-app-directory",children:"1. Create the App Directory"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"app/src/applications/my_app/\n"})}),"\n",(0,t.jsx)(n.h3,{id:"2-create-the-main-source-file",children:"2. Create the Main Source File"}),"\n",(0,t.jsxs)(n.p,{children:["Create ",(0,t.jsx)(n.code,{children:"my_app_app.c"})," with the registration pattern:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'#include <zephyr/kernel.h>\n#include <zephyr/init.h>\n#include <zephyr/logging/log.h>\n\n#include <lvgl.h>\n#include <stdbool.h>\n\n#include "managers/zsw_app_manager.h"\n#include "ui/utils/zsw_ui_utils.h"\n\nLOG_MODULE_REGISTER(my_app, LOG_LEVEL_INF);\n\nstatic void my_app_start(lv_obj_t *root, lv_group_t *group);\nstatic void my_app_stop(void);\nstatic bool my_app_back(void);\nstatic void my_app_ui_unavailable(void);\nstatic void my_app_ui_available(void);\n\nZSW_LV_IMG_DECLARE(my_app_icon);\n\nstatic application_t app = {\n    .name = "My App",\n    .icon = ZSW_LV_IMG_USE(my_app_icon),\n    .start_func = my_app_start,\n    .stop_func = my_app_stop,\n    .back_func = my_app_back,                     // Optional\n    .ui_unavailable_func = my_app_ui_unavailable, // Optional\n    .ui_available_func = my_app_ui_available,     // Optional\n    .category = ZSW_APP_CATEGORY_TOOLS,\n};\n\nstatic void my_app_start(lv_obj_t *root, lv_group_t *group)\n{\n    // Create your LVGL UI under root\n    lv_obj_t *label = lv_label_create(root);\n    lv_label_set_text(label, "Hello from My App!");\n    lv_obj_center(label);\n}\n\nstatic void my_app_stop(void)\n{\n    // Clean up all LVGL objects, timers, and subscriptions\n}\n\nstatic bool my_app_back(void)\n{\n    // Optional: handle the back button.\n    // Return true to consume the event (stay in app).\n    // Return false to exit the app.\n    return false;\n}\n\nstatic void my_app_ui_unavailable(void)\n{\n    // Optional: called when the screen turns off.\n    // Stop timers and pause UI updates here.\n}\n\nstatic void my_app_ui_available(void)\n{\n    // Optional: called when the screen turns back on.\n    // Resume UI updates here.\n}\n\nstatic int my_app_add(void)\n{\n    zsw_app_manager_add_application(&app);\n    return 0;\n}\n\nSYS_INIT(my_app_add, APPLICATION, CONFIG_APPLICATION_INIT_PRIORITY);\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key points:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"SYS_INIT"})," at the bottom registers your app at boot. No other file needs to know about it."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"start_func"})," receives a ",(0,t.jsx)(n.code,{children:"root"})," LVGL object. Create all your widgets as children of ",(0,t.jsx)(n.code,{children:"root"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"stop_func"})," must clean up everything (the app manager deletes ",(0,t.jsx)(n.code,{children:"root"})," for you, but you must delete your own timers and unsubscribe from events)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"back_func"}),", ",(0,t.jsx)(n.code,{children:"ui_unavailable_func"}),", and ",(0,t.jsx)(n.code,{children:"ui_available_func"})," are optional but recommended for good UX and correct behavior."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"3-add-a-kconfig-entry-optional",children:"3. Add a Kconfig Entry (optional)"}),"\n",(0,t.jsxs)(n.p,{children:["If the app shall not always be included in build and you want the user to choose then create a ",(0,t.jsx)(n.code,{children:"Kconfig"})," file in your app directory:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-kconfig",children:'# Copyright (c) 2025 ZSWatch Project\n# SPDX-License-Identifier: Apache-2.0\n\nmenu "My App"\n    config APPLICATIONS_USE_MY_APP\n        bool\n        prompt "Activate the application \'My App\'"\n        default y\n\n    menu "Configuration"\n        depends on APPLICATIONS_USE_MY_APP\n\n        config APPLICATIONS_CONFIGURATION_MY_APP_REFRESH_INTERVAL_MS\n            int\n            prompt "Refresh interval in milliseconds"\n            default 100\n    endmenu\nendmenu\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Then include it from the parent ",(0,t.jsx)(n.code,{children:"app/src/applications/Kconfig"})," by adding:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-kconfig",children:'rsource "my_app/Kconfig"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"4-create-cmakeliststxt",children:"4. Create CMakeLists.txt"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-cmake",children:"# Copyright (c) 2025 ZSWatch Project\n# SPDX-License-Identifier: Apache-2.0\n\nif(CONFIG_APPLICATIONS_USE_MY_APP)\n    FILE(GLOB app_sources *.c)\n    target_sources(app PRIVATE ${app_sources})\nendif()\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"CONFIG_APPLICATIONS_USE_MY_APP"})," guard lets users enable/disable your app via Kconfig. If the app requires a specific HW not available on all ZSWatch versions, this can also be included in the ",(0,t.jsx)(n.code,{children:"if"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"5-provide-an-icon",children:"5. Provide an Icon"}),"\n",(0,t.jsx)(n.p,{children:"Place an icon image for your app. The build system handles icon storage (internal or external flash). In your code, declare and use the icon with:"}),"\n",(0,t.jsxs)(n.p,{children:["For details on adding or updating icons, see ",(0,t.jsx)(n.a,{href:"/docs/development/image_resources",children:"Image Resources"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"ZSW_LV_IMG_DECLARE(my_app_icon);       // File scope declaration\n\n.icon = ZSW_LV_IMG_USE(my_app_icon),   // In the application_t struct\n"})}),"\n",(0,t.jsx)(n.p,{children:"These macros abstract away whether the image is stored in internal or external flash."}),"\n",(0,t.jsxs)(n.h2,{id:"the-application_t-struct",children:["The ",(0,t.jsx)(n.code,{children:"application_t"})," Struct"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Field"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Required"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"name"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"char *"})}),(0,t.jsx)(n.td,{children:"Yes"}),(0,t.jsx)(n.td,{children:"Display name shown in the app picker."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"icon"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"const void *"})}),(0,t.jsx)(n.td,{children:"Yes"}),(0,t.jsxs)(n.td,{children:["App icon. Use ",(0,t.jsx)(n.code,{children:"ZSW_LV_IMG_USE(icon_name)"}),"."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"start_func"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"void (*)(lv_obj_t *, lv_group_t *)"})}),(0,t.jsx)(n.td,{children:"Yes"}),(0,t.jsxs)(n.td,{children:["Called when the app launches. Create all UI under ",(0,t.jsx)(n.code,{children:"root"}),"."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"stop_func"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"void (*)(void)"})}),(0,t.jsx)(n.td,{children:"Yes"}),(0,t.jsx)(n.td,{children:"Called when the app exits. Must clean up all LVGL objects, timers, and subscriptions."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"back_func"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"bool (*)(void)"})}),(0,t.jsx)(n.td,{children:"No"}),(0,t.jsxs)(n.td,{children:["Called on back button press. Return ",(0,t.jsx)(n.code,{children:"true"})," to consume (stay in app), ",(0,t.jsx)(n.code,{children:"false"})," to exit."]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ui_unavailable_func"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"void (*)(void)"})}),(0,t.jsx)(n.td,{children:"No"}),(0,t.jsx)(n.td,{children:"Called when the screen turns off. Pause UI updates."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ui_available_func"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"void (*)(void)"})}),(0,t.jsx)(n.td,{children:"No"}),(0,t.jsx)(n.td,{children:"Called when the screen turns back on. Resume UI updates."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"category"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"zsw_app_category_t"})}),(0,t.jsx)(n.td,{children:"Yes"}),(0,t.jsx)(n.td,{children:"Determines which folder the app appears in within the app picker."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"hidden"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"bool"})}),(0,t.jsx)(n.td,{children:"No"}),(0,t.jsxs)(n.td,{children:["If ",(0,t.jsx)(n.code,{children:"true"}),", the app does not appear in the app picker (useful for background services)."]})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"app-categories",children:"App Categories"}),"\n",(0,t.jsx)(n.p,{children:"Categories control where your app appears in the app picker's folder structure:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Category"}),(0,t.jsx)(n.th,{children:"Constant"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Root"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_CATEGORY_ROOT"})}),(0,t.jsx)(n.td,{children:"Top-level, no folder. Appears directly in the main app list."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Tools"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_CATEGORY_TOOLS"})}),(0,t.jsx)(n.td,{children:"Tools folder."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Fitness"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_CATEGORY_FITNESS"})}),(0,t.jsx)(n.td,{children:"Fitness folder."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"System"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_CATEGORY_SYSTEM"})}),(0,t.jsx)(n.td,{children:"System folder."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Games"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_CATEGORY_GAMES"})}),(0,t.jsx)(n.td,{children:"Games folder."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Sensors"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_CATEGORY_SENSORS"})}),(0,t.jsx)(n.td,{children:"Sensors folder."})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Random"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ZSW_APP_CATEGORY_RANDOM"})}),(0,t.jsx)(n.td,{children:"Random/misc folder."})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"subscribing-to-events-zbus",children:"Subscribing to Events (Zbus)"}),"\n",(0,t.jsxs)(n.p,{children:["ZSWatch uses Zephyr's ",(0,t.jsx)(n.strong,{children:"zbus"})," for inter-module event communication. Apps can subscribe to sensor data, BLE events, notifications, and more."]}),"\n",(0,t.jsx)(n.h3,{id:"example-listening-for-ble-data",children:"Example: Listening for BLE Data"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'#include <zephyr/zbus/zbus.h>\n#include "events/ble_event.h"\n\nstatic void zbus_ble_comm_data_callback(const struct zbus_channel *chan);\nstatic void handle_ble_data(struct k_work *item);\n\nZBUS_CHAN_DECLARE(ble_comm_data_chan);\nZBUS_LISTENER_DEFINE(my_app_ble_lis, zbus_ble_comm_data_callback);\n\nstatic K_WORK_DEFINE(ble_data_work, handle_ble_data);\n\nstatic void zbus_ble_comm_data_callback(const struct zbus_channel *chan)\n{\n    // WARNING: This runs in the publisher\'s context (e.g., BLE thread).\n    // Do NOT do heavy work or touch LVGL here.\n    // Store the data/state etc.\n    // Context-switch to a work queue instead:\n    k_work_submit(&ble_data_work);\n}\n\nstatic void handle_ble_data(struct k_work *item)\n{\n    // Safe to do real work here (runs on the system work queue)\n    if (app.current_state == ZSW_APP_STATE_UI_VISIBLE) {\n        // Update UI\n    }\n}\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["Zbus listener callbacks run in the ",(0,t.jsx)(n.strong,{children:"publisher's thread context"}),", which often has a small stack (e.g., the BLE thread). Always use ",(0,t.jsx)(n.code,{children:"k_work_submit()"})," to move non-trivial processing to the system work queue."]})}),"\n",(0,t.jsx)(n.h2,{id:"periodic-events",children:"Periodic Events"}),"\n",(0,t.jsxs)(n.p,{children:["For apps that need regular updates (e.g., refreshing a sensor reading), ZSWatch provides shared periodic event channels. Subscribe in ",(0,t.jsx)(n.code,{children:"start_func"})," and unsubscribe in ",(0,t.jsx)(n.code,{children:"stop_func"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'#include "events/zsw_periodic_event.h"\n\nZBUS_CHAN_DECLARE(periodic_event_100ms_chan);\nZBUS_LISTENER_DEFINE(my_app_100ms_listener, my_periodic_callback);\n\nstatic void my_app_start(lv_obj_t *root, lv_group_t *group)\n{\n    // ... create UI ...\n    zsw_periodic_chan_add_obs(&periodic_event_100ms_chan, &my_app_100ms_listener);\n}\n\nstatic void my_app_stop(void)\n{\n    zsw_periodic_chan_rm_obs(&periodic_event_100ms_chan, &my_app_100ms_listener);\n    // ... clean up UI ...\n}\n\nstatic void my_periodic_callback(const struct zbus_channel *chan)\n{\n    if (app.current_state == ZSW_APP_STATE_UI_VISIBLE) {\n        // Update UI at 100ms intervals\n    }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"Available periodic channels:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Channel"}),(0,t.jsx)(n.th,{children:"Interval"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"periodic_event_100ms_chan"})}),(0,t.jsx)(n.td,{children:"100 ms"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"periodic_event_1s_chan"})}),(0,t.jsx)(n.td,{children:"1 second"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"periodic_event_10s_chan"})}),(0,t.jsx)(n.td,{children:"10 seconds"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"ui-pattern",children:"UI Pattern"}),"\n",(0,t.jsx)(n.h3,{id:"recommended-separate-logic-and-ui",children:"Recommended: Separate Logic and UI"}),"\n",(0,t.jsx)(n.p,{children:"Split your app into a logic file and a UI file:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"app/src/applications/my_app/\n\u251c\u2500\u2500 my_app_app.c       # App registration, lifecycle, data handling\n\u251c\u2500\u2500 my_app_ui.c        # LVGL widget creation and updates\n\u2514\u2500\u2500 my_app_ui.h        # UI function prototypes\n"})}),"\n",(0,t.jsx)(n.p,{children:"The UI header exposes a simple interface:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"#pragma once\n\n#include <lvgl.h>\n\nvoid my_app_ui_show(lv_obj_t *root);\nvoid my_app_ui_remove(void);\nvoid my_app_ui_update_value(int value);\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This keeps the app logic clean and the LVGL code contained. The compass app is a good example of this pattern. See ",(0,t.jsx)(n.code,{children:"compass_app.c"})," and ",(0,t.jsx)(n.code,{children:"compass_ui.c"})," / ",(0,t.jsx)(n.code,{children:"compass_ui.h"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"advanced-lvgl-editor-xml-based-ui",children:"Advanced: LVGL Editor (XML-Based UI)"}),"\n",(0,t.jsxs)(n.p,{children:["For more complex UIs, ZSWatch supports the ",(0,t.jsx)(n.strong,{children:"LVGL Editor"}),", an XML-based visual design tool that generates C code automatically. See the LVGL Editor guide in the repo: ",(0,t.jsx)(n.a,{href:"https://github.com/zswatch/ZSWatch/blob/main/app/lvgl_editor/README.md",children:"https://github.com/zswatch/ZSWatch/blob/main/app/lvgl_editor/README.md"})]}),"\n",(0,t.jsx)(n.p,{children:"With this approach:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Define reactive ",(0,t.jsx)(n.strong,{children:"subjects"})," in ",(0,t.jsx)(n.code,{children:"app/lvgl_editor/globals.xml"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Create component XML files in ",(0,t.jsx)(n.code,{children:"app/lvgl_editor/components/<name>/"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Generate code from the editor \u2192 produces ",(0,t.jsx)(n.code,{children:"*_gen.c"})," / ",(0,t.jsx)(n.code,{children:"*_gen.h"})," files."]}),"\n",(0,t.jsx)(n.li,{children:"In your app code, create the component and update UI via subjects:"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'#include "lvgl_editor_gen.h"\n#include "my_component_gen.h"\n\nlv_subject_copy_string(&my_text_subject, "Hello");\nlv_subject_set_int(&my_value_subject, 42);\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The music control app (",(0,t.jsx)(n.code,{children:"music_control_app.c"}),") is a good reference for this pattern."]}),"\n",(0,t.jsx)(n.admonition,{type:"caution",children:(0,t.jsxs)(n.p,{children:["Never manually edit ",(0,t.jsx)(n.code,{children:"*_gen.c"})," or ",(0,t.jsx)(n.code,{children:"*_gen.h"})," files. They are auto-generated by the LVGL Editor and will be overwritten."]})}),"\n",(0,t.jsx)(n.h2,{id:"common-pitfalls",children:"Common Pitfalls"}),"\n",(0,t.jsx)(n.h3,{id:"1-always-check-app-state-before-updating-ui",children:"1. Always Check App State Before Updating UI"}),"\n",(0,t.jsx)(n.p,{children:"The screen can turn off while your app is running. Guard all LVGL calls where needed:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:'if (app.current_state == ZSW_APP_STATE_UI_VISIBLE) {\n    lv_label_set_text(my_label, "Updated!");\n}\n'})}),"\n",(0,t.jsxs)(n.h3,{id:"2-clean-up-everything-in-stop_func",children:["2. Clean Up Everything in ",(0,t.jsx)(n.code,{children:"stop_func"})]}),"\n",(0,t.jsx)(n.p,{children:"Delete all timers, unsubscribe from periodic events, and remove UI elements:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"static void my_app_stop(void)\n{\n    zsw_periodic_chan_rm_obs(&periodic_event_100ms_chan, &my_app_100ms_listener);\n    if (refresh_timer) {\n        lv_timer_del(refresh_timer);\n        refresh_timer = NULL;\n    }\n    my_app_ui_remove();\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Forgetting to unsubscribe from periodic events will cause callbacks to fire after the app is closed, likely crashing the watch."}),"\n",(0,t.jsx)(n.h3,{id:"3-context-switch-from-zbus-callbacks",children:"3. Context-Switch From Zbus Callbacks"}),"\n",(0,t.jsxs)(n.p,{children:["Never do heavy work or call LVGL functions directly in a zbus listener callback. Use ",(0,t.jsx)(n.code,{children:"k_work_submit()"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c",children:"static void zbus_callback(const struct zbus_channel *chan)\n{\n    // Copy data if needed, then:\n    k_work_submit(&my_work);\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"4-round-display",children:"4. Round Display"}),"\n",(0,t.jsxs)(n.p,{children:["The display is 240\xd7240 pixels and ",(0,t.jsx)(n.strong,{children:"circular"}),". Content placed in the corners will be clipped. Design your layouts accordingly."]}),"\n",(0,t.jsx)(n.h3,{id:"5-memory-constraints",children:"5. Memory Constraints"}),"\n",(0,t.jsx)(n.p,{children:"RAM is limited (512 KB shared with the BLE stack). Be mindful of stack sizes, heap allocations, and the number of LVGL objects you create."})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>a});var s=i(6540);const t={},r=s.createContext(t);function c(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);